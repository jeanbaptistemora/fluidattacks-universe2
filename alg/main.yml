---
- hosts: alg

  become: yes

  tasks:
   - name: Incluir llaves de cifrado
     include_vars: ansible/templates/key.yml

   - name: Incluir variables de configuracion
     include_vars: ansible/templates/vars.yml

   - name: Instalar Apache
     apt: 
       pkg: "apache2" 
       state: present

   - name: Habilitar Apache como servicio
     service:
       name: "apache2"
       enabled: yes

   - name: Habilitar modulos necesarios de Apache
     command:
       a2enmod {{ item }}
     with_items:
       - rewrite
       - ssl
       - proxy_http
       - substitute
       - headers
     notify:
       - reiniciar apache2

   - name: Creando configuraci√≥n Apache
     template:
      src: "ansible/templates/apache2.j2"
      dest: "/etc/apache2/apache2.conf"
      mode: "0644"

   - name: Creando sitio por defecto
     template:
      src: "ansible/templates/000-default.j2"
      dest: "/etc/apache2/sites-enabled/000-default.conf"
      mode: "0644"

   - name: Creando fluid.la
     template:
      src: "ansible/templates/fluid.la.j2"
      dest: "/etc/apache2/sites-enabled/fluid.la"
      mode: "0644"

   - name: Creando www.fluid.la
     template:
      src: "ansible/templates/www.fluid.la.j2"
      dest: "/etc/apache2/sites-enabled/www.fluid.la"
      mode: "0644"


   - name: Creando sitio ssl
     template:
      src: "ansible/templates/defaultssl.j2"
      dest: "/etc/apache2/sites-enabled/default-ssl"
      mode: "0644"

   - name: Instalando certificado digital
     copy:
      content: '{{ ssl_cert }}'
      dest: /etc/ssl/certs/fluidla.crt
      owner: root
      group: root
      mode: 0644
 
   - name: Instalando llave privada ssl
     copy:
      content: '{{ ssl_key }}'
      dest: /etc/ssl/private/fluidla.key
      owner: root
      group: root
      mode: 0600
     notify:
       - reiniciar apache2

  handlers:
   - name: reiniciar apache2
     service: 
       name: "apache2" 
       state: "restarted"

