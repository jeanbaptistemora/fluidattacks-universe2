.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true
  variables:
    GIT_DEPTH: 5

.skims_commit_pattern: &skims_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|skims)/'

.skims_in_dev_branch: &skims_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *skims_commit_pattern

.skims_in_dev_and_master_branch: &skims_in_dev_and_master_branch
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *skims_commit_pattern

.skims_in_master_branch: &skims_in_master_branch
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *skims_commit_pattern

skims_deploy_infra:
  <<: *with_nix
  <<: *skims_in_master_branch
  stage: deploy-app

skims_deploy_to_pypi:
  <<: *with_nix
  <<: *skims_in_master_branch
  stage: deploy-app

skims_lint:
  <<: *with_nix
  <<: *skims_in_dev_and_master_branch
  stage: lint-code

skims_process_all_groups_on_aws:
  <<: *with_nix
  interruptible: false
  only:
    refs: [schedules]
    variables: [$skims_process_all_groups_on_aws]
  stage: scheduler
  tags: [autoscaling]

skims_security:
  <<: *with_nix
  <<: *skims_in_dev_and_master_branch
  stage: test-security

skims_structure:
  <<: *with_nix
  <<: *skims_in_dev_and_master_branch
  artifacts:
    expire_in: 1 week
    paths:
      - skims/*.svg
    when: on_success
  stage: test-code

skims_test:
  <<: *with_nix
  <<: *skims_in_dev_branch
  stage: test-code

skims_test_infra:
  <<: *with_nix
  <<: *skims_in_dev_branch
  stage: test-code

skims_documentation:
  <<: *with_nix
  <<: *skims_in_master_branch
  stage: deploy-app

skims_process_group_on_aws:
  <<: *with_nix
  rules:
    - if: '$CI_PIPELINE_SOURCE != "trigger"'
      when: never
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$SKIMS_GROUP_TO_PROCESS_ON_AWS != null'
  tags: [autoscaling]
  stage: scheduler