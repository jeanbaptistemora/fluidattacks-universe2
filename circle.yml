#
# Archivo de configuracion del servicio de integraciÃ³n continua.
#
---
version: 2
jobs:
  build:
    working_directory: /tmp/fluid-serves
    machine: true
    evironment:
      - USER: root
    steps:
      - checkout
      - run:
          name: Update
          command: sudo apt-get update
      - run:
          name: Install dependencies
          command: >
           sudo apt-get install -y software-properties-common &&
           gem install overcommit
      - run:
          name: Vault file
          command: >
              sudo echo $VAULT > ~/.vault.txt &&
              sudo echo $VAULT > /tmp/.vault.txt
      - run:
          name: add ansible repo
          command: >
                sudo echo "deb http://ppa.launchpad.net/ansible/ansible/ubuntu
                trusty main" | sudo tee -a /etc/apt/sources.list &&  sudo
                apt-get update
      - run:
          name: pip installations
          command: >
                sudo apt-get install -y python-dev python-pip && sudo
                pip install --upgrade --force pip setuptools && sudo pip
                install ansible-lint && sudo pip install pep257 pep8
                pyflakes pylint flake8 yamllint
      - run:
          name: Install ansible
          command: sudo apt-get install -y --force-yes ansible
      - run:
          name: Ansible lints
          command: >
                ansible-lint containers/alg/main.yml && ansible-lint
                containers/exams/main.yml && ansible-lint
                containers/integrates/main.yml && ansible-lint
                containers/host/main.yml
      - run:
          name: Overcommit
          command: overcommit --sign && overcommit --run

      - run:
          name: Bundle install
          command: bundle install

      - run:
          name: Build base image
          command: >
                sudo containers/base/build.sh

      - run:
          name: Make alg tests
          command: >
                cp /tmp/.vault.txt containers/alg/ &&
                cd containers/alg && bundle exec rspec
      - run:
          name: Make exams tests
          command: >
                cp /tmp/.vault.txt containers/exams/ &&
                cd containers/exams && bundle exec rspec

      - run:
          name: Build images
          command: >
                sudo ./start.sh

      - run:
          name: Install FLUIDAsserts
          command: >
                sudo apt-get install -y libffi-dev libssl-dev g++ gcc &&
                pip install fluidasserts
      - run:
          name: Run asserts
          command: python asserts.py
      - run:
          name: docker images
          command: docker images

           # Deploy master
      - deploy:
          command: |
            if [ "${CIRCLE_BRANCH}" == "jrestrepo" ];
              then sudo aws configure set aws_access_key_id $AWS_KEY_ID && \
              sudo aws configure set aws_secret_access_key $AWS_SECRET_KEY && \
              sudo aws ecr get-login --region us-east-1 >> login.sh && sudo sh login.sh && \
              sudo docker -D push 205810638802.dkr.ecr.us-east-1.amazonaws.com/serves:alg && \
              sudo docker -D push 205810638802.dkr.ecr.us-east-1.amazonaws.com/serves:exams && \
              sudo docker -D push 205810638802.dkr.ecr.us-east-1.amazonaws.com/integrates:base;
            fi
