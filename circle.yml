#
# Archivo de configuracion del servicio de integración continua.
#

version: 2
jobs:
  build:
    docker:
      - image: ruby:2.3
      - image: python:2.7

    working_directory: /root/fluid-serves
    steps:
      - checkout
      # - run:
      #     name: Este parche se requiere para que docker soporte especificación de IPs
      #     command: curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0

      # ... steps for building/testing app ...

      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.03.0-ce"
            curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
            tar -xz -C /tmp -f /tmp/docker-$VER.tgz
            mv /tmp/docker/* /usr/bin
      - run:
          name: Starting docker daemon
          command: nohup docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock && docker info
      - run:
          name: Install dependencies
          command:  apt-get update &&  apt-get install -y software-properties-common  && echo $VAULT > ~/.vault.txt

      - run:
          name: Install netcat
          command: apt-get install -y netcat
      - run:
          name: add ansible repo
          command:  echo "deb http://ppa.launchpad.net/ansible/ansible/ubuntu trusty main" | tee -a /etc/apt/sources.list &&  apt-get update
      - run:
          name: pip installations
          command:  apt-get install -y python-dev && apt-get install -y python-pip && pip install --upgrade pip setuptools && pip install ansible-lint
      - run:
          name: Install ansible
          command:  apt-get install -y --force-yes ansible curl

      - run:
          name: Ansible lints
          command: ansible-lint servers/alg/main.yml && ansible-lint servers/exams/main.yml && ansible-lint servers/integrates/main.yml && ansible-lint servers/host/main.yml

      - run:
          name: Start
          command: ./start.sh && bundle install

      - run:
          name: Make exams tests
          command: cd servers/exams/serverspec && bundle exec rake spec
      - run:
          name: Make alg tests
          command: cd servers/alg/serverspec && bundle exec rake spec
