.makes: &makes
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/makes"
  needs: []
  interruptible: true
  script:
    - ./m "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.sorts_commit_pattern: &sorts_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|sorts)/'

.sorts_in_dev_branch: &sorts_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *sorts_commit_pattern

.sorts_in_dev_and_master_branch: &sorts_in_dev_and_master_branch
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *sorts_commit_pattern

.sorts_in_master_branch: &sorts_in_master_branch
  resource_group: "${CI_JOB_NAME}"
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *sorts_commit_pattern

.sorts_in_schedule_extract_features: &sorts_in_schedule_extract_features
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: never
    - if: '$sorts_extract_features != "defined"'
      when: never
    - when: always

.sorts_in_schedule_train: &sorts_in_schedule_train
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: never
    - if: '$sorts_train != "defined"'
      when: never
    - when: always

.sorts_in_schedule_execute: &sorts_in_schedule_execute
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: never
    - if: '$sorts_execute != "defined"'
      when: never
    - when: always

makes.test.sorts:
  <<: *makes
  <<: *sorts_in_master_branch
  stage: test-code

sorts.test:
  <<: *makes
  <<: *sorts_in_dev_branch
  stage: test-code

sorts.infra.test:
  <<: *makes
  <<: *sorts_in_dev_branch
  stage: test-infra

sorts.infra.deploy:
  <<: *makes
  <<: *sorts_in_master_branch
  stage: deploy-infra

sorts.execute:
  <<: *makes
  <<: *sorts_in_schedule_execute
  stage: test-code
  interruptible: false

# Sorts extract features scheduled pipeline
sorts.extract-features:
  <<: *makes
  <<: *sorts_in_schedule_extract_features
  interruptible: false
  parallel: 15
  stage: pre-build
  tags: [autoscaling-large]

sorts.merge-features:
  <<: *makes
  <<: *sorts_in_schedule_extract_features
  interruptible: false
  needs: [sorts.extract-features]
  stage: build

# Sorts training scheduled pipeline
sorts.train:
  <<: *makes
  <<: *sorts_in_schedule_train
  interruptible: false
  stage: deploy-app

sorts.tune:
  <<: *makes
  <<: *sorts_in_schedule_train
  interruptible: false
  needs: [sorts.train]
  stage: post-deploy
