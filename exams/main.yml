---
- hosts: exams

  become: yes

  tasks:
   - name: Inlcuir variables (Vault)
     include_vars: ansible/templates/vars.yml

   - name: Instalar paquetes necesarios
     apt: name="{{ item }}"
     with_items:
       - apache2
       - php5
       - php5-gd
       - php5-xmlrpc
       - php5-intl
       - php5-mysql
       - php5-curl
       - curl
       - git
       - mysql-server
       - python-mysqldb

   - name: Retirar index
     file: path=/var/www/html/index.html state=absent

   - name: Habilitar servicios
     service: name="{{ item }}" state=started enabled=yes
     with_items:
       - apache2
       - mysql

   - name: Crear DB para moodle
     mysql_db: name="{{ db_name }}" state="present"

   - name: Crear usuario moodle y asignar permisos
     mysql_user: name="{{ db_username }}" password="{{ db_password }}" priv="{{ db_name }}.*:ALL"

   - name: Remover base de datos de prueba
     mysql_db: name=test state=absent

   - name: Remover conexiones anonimas MySQL
     mysql_user: name='' host=localhost state=absent

   - name: Actualizar password de usuario root en MySQL
     mysql_user: name=root host=localhost password={{ db_pwd_root }}

   - name: Descargando Moodle
     git: repo=git://git.moodle.org/moodle.git dest="/var/www/html" version=MOODLE_31_STABLE

   - name: Establecer permisos 
     file: path=/var/www/html state=directory owner=www-data group=www-data mode=0755 recurse=yes

   - name: Crear directorio para los datos de Moodle 
     file: path=/var/www/moodledata state=directory owner=www-data group=www-data mode=0777 recurse=yes

   - name: Configure Moodle
     template: src=ansible/templates/config.j2 dest="/var/www/html/config.php"

  handlers:
   - name: restart apache2
     service: name=apache2 state=restarted
