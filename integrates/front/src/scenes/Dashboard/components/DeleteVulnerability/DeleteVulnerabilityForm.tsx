import { useMutation } from "@apollo/client";
import type { ApolloError } from "@apollo/client";
import type { PureAbility } from "@casl/ability";
import { useAbility } from "@casl/react";
import type { GraphQLError } from "graphql";
import React, { useCallback } from "react";
import { Field } from "redux-form";

import { DELETE_VULN_MUTATION } from "scenes/Dashboard/components/DeleteVulnerability/queries";
import type {
  IDeleteVulnAttr,
  IDeleteVulnerabilityProps,
} from "scenes/Dashboard/components/DeleteVulnerability/types";
import { GenericForm } from "scenes/Dashboard/components/GenericForm";
import { GET_FINDING_HEADER } from "scenes/Dashboard/containers/FindingContent/queries";
import { GET_FINDING_VULN_INFO } from "scenes/Dashboard/containers/VulnerabilitiesView/queries";
import { ControlLabel, FormGroup } from "styles/styledComponents";
import { authzPermissionsContext } from "utils/authz/config";
import { Dropdown } from "utils/forms/fields";
import { Logger } from "utils/logger";
import { msgError } from "utils/notifications";
import { translate } from "utils/translations/translate";
import { required } from "utils/validations";

export const DeleteVulnerabilityForm: (
  props: IDeleteVulnerabilityProps
) => JSX.Element = (props: IDeleteVulnerabilityProps): JSX.Element => {
  const { findingId, groupName, id } = props;

  const permissions: PureAbility<string> = useAbility(authzPermissionsContext);
  const handleDeleteResult: (data: IDeleteVulnAttr) => void = useCallback(
    (data: IDeleteVulnAttr): void => {
      props.onDeleteVulnRes(data);
    },
    [props]
  );

  const handleDeleteError: ({
    graphQLErrors,
  }: ApolloError) => void = useCallback(
    ({ graphQLErrors }: ApolloError): void => {
      graphQLErrors.forEach((error: GraphQLError): void => {
        Logger.warning("An error occurred deleting vulnerabilities", error);
        msgError(translate.t("groupAlerts.errorTextsad"));
      });
    },
    []
  );

  const [deleteVulnerability] = useMutation(DELETE_VULN_MUTATION, {
    onCompleted: handleDeleteResult,
    onError: handleDeleteError,
    refetchQueries: [
      {
        query: GET_FINDING_HEADER,
        variables: {
          canGetHistoricState: permissions.can(
            "backend_api_resolvers_finding_historic_state_resolve"
          ),
          findingId,
        },
      },
      {
        query: GET_FINDING_VULN_INFO,
        variables: {
          canRetrieveAnalyst: permissions.can(
            "backend_api_resolvers_vulnerability_analyst_resolve"
          ),
          canRetrieveZeroRisk: permissions.can(
            "backend_api_resolvers_finding_zero_risk_resolve"
          ),
          findingId,
          groupName,
        },
      },
    ],
  });

  const handleDelete: (values: { justification: string }) => void = useCallback(
    (values: { justification: string }): void => {
      void deleteVulnerability({
        variables: {
          findingId,
          id,
          justification: values.justification,
        },
      });
    },
    [deleteVulnerability, findingId, id]
  );

  return (
    <GenericForm name={"deleteVulnerability"} onSubmit={handleDelete}>
      <FormGroup>
        <ControlLabel>
          {translate.t("searchFindings.delete.justif.label")}
        </ControlLabel>
        <Field
          component={Dropdown}
          name={"justification"}
          validate={[required]}
        >
          <option value={""} />
          <option value={"DUPLICATED"}>
            {translate.t("searchFindings.delete.justif.duplicated")}
          </option>
          <option value={"FALSE_POSITIVE"}>
            {translate.t("searchFindings.delete.justif.falsePositive")}
          </option>
          <option value={"REPORTING_ERROR"}>
            {translate.t("deleteVulns.reportingError")}
          </option>
        </Field>
      </FormGroup>
    </GenericForm>
  );
};
