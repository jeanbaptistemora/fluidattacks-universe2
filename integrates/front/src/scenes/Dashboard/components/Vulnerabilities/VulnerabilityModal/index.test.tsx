import type { MockedResponse } from "@apollo/client/testing";
import { MockedProvider } from "@apollo/client/testing";
import { PureAbility } from "@casl/ability";
import { render, screen, waitFor } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import React from "react";
import { MemoryRouter } from "react-router-dom";

import { AdditionalInformation } from ".";
import type { IVulnRowAttr } from "../types";
import { GET_VULN_ADDITIONAL_INFO } from "scenes/Dashboard/components/Vulnerabilities/AdditionalInfo/queries";
import { getLastTreatment } from "scenes/Dashboard/components/Vulnerabilities/UpdateDescription/utils";
import { authzPermissionsContext } from "utils/authz/config";
import { formatDropdownField } from "utils/formatHelpers";

describe("AdditionalInformation", (): void => {
  const mockedPermissions: PureAbility<string> = new PureAbility([
    { action: "api_mutations_remove_vulnerability_tags_mutate" },
    { action: "api_mutations_request_vulnerabilities_zero_risk_mutate" },
    { action: "api_mutations_update_vulnerability_treatment_mutate" },
    { action: "api_mutations_update_vulnerabilities_treatment_mutate" },
  ]);
  const mock: IVulnRowAttr = {
    assigned: "",
    currentState: "open",
    currentStateCapitalized: "Open",
    externalBugTrackingSystem: null,
    findingId: "testgroup",
    groupName: "480857698",
    historicTreatment: [
      {
        acceptanceDate: "",
        acceptanceStatus: "",
        assigned: "usertreatment@test.test",
        date: "2019-07-05 09:56:40",
        justification: "test progress justification",
        treatment: "IN PROGRESS",
        user: "usertreatment@test.test",
      },
    ],
    id: "89521e9a-b1a3-4047-a16e-15d530dc1340",
    lastTreatmentDate: "2019-07-05 09:56:40",
    lastVerificationDate: null,
    remediated: true,
    reportDate: "",
    severity: "3",
    specific: "specific-1",
    stream: null,
    tag: "tag-1, tag-2",
    treatment: formatDropdownField("IN_PROGRESS"),
    treatmentAcceptanceDate: "",
    treatmentAcceptanceStatus: "",
    treatmentAssigned: "",
    treatmentDate: "2019-07-05 09:56:40",
    treatmentJustification: "test progress justification",
    treatmentUser: "usertreatment@test.test",
    verification: "Requested",
    vulnerabilityType: "inputs",
    where: "https://example.com/inputs",
    zeroRisk: null,
  };

  const mockQueryVulnAdditionalInfo: MockedResponse = {
    request: {
      query: GET_VULN_ADDITIONAL_INFO,
      variables: {
        canRetrieveHacker: true,
        vulnId: "89521e9a-b1a3-4047-a16e-15d530dc1340",
      },
    },
    result: {
      data: {
        vulnerability: {
          __typename: "Vulnerability",
          commitHash: null,
          cycles: "1",
          efficacy: "0",
          hacker: "hacker@test.com",
          historicTreatment: [
            {
              acceptanceDate: "",
              date: "2019-07-05 09:56:40",
              treatment: "IN PROGRESS",
              user: "usertreatment@test.test",
            },
          ],
          lastReattackRequester: "",
          lastRequestedReattackDate: null,
          lastStateDate: "2020-09-05 03:23:23",
          lastTreatmentDate: "2019-07-05 09:56:40",
          reportDate: "",
          severity: "3",
          stream: null,
          treatment: "IN_PROGRESS",
          treatmentAcceptanceDate: "",
          treatmentAssigned: "",
          treatmentChanges: "1",
          treatmentJustification: "test progress justification",
          vulnerabilityType: "inputs",
        },
      },
    },
  };

  it("should return a function", (): void => {
    expect.hasAssertions();

    expect(typeof AdditionalInformation).toBe("function");
  });

  it("should render vulnerabilities modal and keep info between tabs", async (): Promise<void> => {
    expect.hasAssertions();

    const onCloseAdditionalInfoModal: jest.Mock = jest.fn();
    render(
      <authzPermissionsContext.Provider value={mockedPermissions}>
        <MemoryRouter initialEntries={["/testgroup/vulns/480857698/locations"]}>
          <MockedProvider
            addTypename={false}
            mocks={[mockQueryVulnAdditionalInfo]}
          >
            <AdditionalInformation
              canDisplayHacker={true}
              canRemoveVulnsTags={true}
              canRequestZeroRiskVuln={true}
              canUpdateVulnsTreatment={true}
              clearSelectedVulns={jest.fn()}
              closeAdditionalInfoModal={onCloseAdditionalInfoModal}
              currentRow={mock}
              findingId={"480857698"}
              groupName={"testgroup"}
              isAdditionalInfoOpen={true}
              isFindingReleased={true}
            />
          </MockedProvider>
        </MemoryRouter>
      </authzPermissionsContext.Provider>
    );

    await waitFor((): void => {
      expect(
        screen.queryByText(
          formatDropdownField(
            getLastTreatment(mock.historicTreatment).treatment
          )
        )
      ).toBeInTheDocument();
    });

    expect(screen.getByText("test progress justification")).toBeInTheDocument();

    userEvent.click(
      screen.getByRole("link", {
        name: "searchFindings.tabVuln.contentTab.treatments.title",
      })
    );

    await waitFor((): void => {
      expect(screen.getByRole("combobox", { name: "treatment" })).toHaveValue(
        "IN_PROGRESS"
      );
    });

    expect(screen.getByRole("textbox", { name: "justification" })).toHaveValue(
      ""
    );

    userEvent.selectOptions(
      screen.getByRole("combobox", { name: "treatment" }),
      ["ACCEPTED"]
    );
    userEvent.type(
      screen.getByRole("textbox", { name: "justification" }),
      "test justification to accepted treatment"
    );

    userEvent.click(
      screen.getByRole("link", {
        name: "searchFindings.tabVuln.contentTab.details.title",
      })
    );

    await waitFor((): void => {
      expect(
        screen.queryByText(
          formatDropdownField(
            getLastTreatment(mock.historicTreatment).treatment
          )
        )
      ).toBeInTheDocument();
    });

    expect(screen.getByText("test progress justification")).toBeInTheDocument();
    expect(
      screen.queryByText("test justification to accepted treatment")
    ).not.toBeInTheDocument();

    userEvent.click(
      screen.getByRole("link", {
        name: "searchFindings.tabVuln.contentTab.treatments.title",
      })
    );

    await waitFor((): void => {
      expect(screen.getByRole("combobox", { name: "treatment" })).toHaveValue(
        "ACCEPTED"
      );
    });

    expect(
      screen.queryByText("test progress justification")
    ).not.toBeInTheDocument();
    expect(
      screen.getByText("test justification to accepted treatment")
    ).toBeInTheDocument();

    userEvent.click(screen.getByText("group.findings.report.modalClose"));
    await waitFor((): void => {
      expect(onCloseAdditionalInfoModal).toHaveBeenCalledTimes(1);
    });
  });
});
