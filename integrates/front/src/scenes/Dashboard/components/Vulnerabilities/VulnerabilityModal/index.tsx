import _ from "lodash";
import React, { useCallback, useMemo, useState } from "react";
import { useTranslation } from "react-i18next";
import { MemoryRouter, Route } from "react-router-dom";

import { UpdateDescriptionContext, defaultValue } from "./context";

import { ContentTab } from "../../ContentTab";
import { AdditionalInfo } from "../AdditionalInfo";
import { TreatmentTracking } from "../TrackingTreatment";
import type {
  IUpdateTreatmentVulnerabilityForm,
  IVulnRowAttr,
  IVulnerabilityModalValues,
} from "../types";
import { UpdateDescription } from "../UpdateDescription";
import { Modal } from "components/Modal";

interface IAdditionalInformationModal {
  canDisplayHacker: boolean;
  canRemoveVulnsTags: boolean;
  canRequestZeroRiskVuln: boolean;
  canUpdateVulnsTreatment: boolean;
  clearSelectedVulns: () => void;
  closeAdditionalInfoModal: () => void;
  currentRow: IVulnRowAttr | undefined;
  findingId: string;
  groupName: string;
  isAdditionalInfoOpen: boolean;
  isFindingReleased: boolean;
}

const AdditionalInformation: React.FC<IAdditionalInformationModal> = ({
  canDisplayHacker,
  canRemoveVulnsTags,
  canRequestZeroRiskVuln,
  canUpdateVulnsTreatment,
  clearSelectedVulns,
  closeAdditionalInfoModal,
  currentRow = undefined,
  findingId,
  groupName,
  isAdditionalInfoOpen,
  isFindingReleased,
}: IAdditionalInformationModal): JSX.Element => {
  const { t } = useTranslation();
  const [treatmentForm, setTreatmentForm] =
    useState<IUpdateTreatmentVulnerabilityForm>(defaultValue);
  const value = useMemo(
    (): IVulnerabilityModalValues => [treatmentForm, setTreatmentForm],
    [treatmentForm, setTreatmentForm]
  );

  const onClose: () => void = useCallback((): void => {
    setTreatmentForm(defaultValue);
    closeAdditionalInfoModal();
  }, [closeAdditionalInfoModal]);

  return (
    <Modal
      headerTitle={t("searchFindings.tabVuln.vulnerabilityInfo")}
      onEsc={onClose}
      open={isAdditionalInfoOpen}
      size={"largeModal"}
    >
      <UpdateDescriptionContext.Provider value={value}>
        {_.isUndefined(currentRow) ? undefined : (
          <MemoryRouter
            initialEntries={["/details", "/treatments"]}
            initialIndex={0}
          >
            <div className={"grid mb0 menu-grid nt3 pl0 pr0 tc-shadow w-100"}>
              <ContentTab
                icon={"icon pe-7s-graph3"}
                id={"vulnerabilityDetailsTab"}
                link={"/details"}
                title={t("searchFindings.tabVuln.contentTab.details.title")}
                tooltip={t("searchFindings.tabVuln.contentTab.details.tooltip")}
              />
              {currentRow.currentState === "open" &&
              isFindingReleased &&
              (canUpdateVulnsTreatment ||
                canRequestZeroRiskVuln ||
                canRemoveVulnsTags) ? (
                <ContentTab
                  icon={"icon pe-7s-note"}
                  id={"vulnerabilityTreatmentsTab"}
                  link={"/treatments"}
                  title={t(
                    "searchFindings.tabVuln.contentTab.treatments.title"
                  )}
                  tooltip={t(
                    "searchFindings.tabVuln.contentTab.treatments.tooltip"
                  )}
                />
              ) : undefined}
              {currentRow.currentState === "open" && isFindingReleased ? (
                <ContentTab
                  icon={"icon pe-7s-graph1"}
                  id={"vulnerability-tracking-treatmentsTab"}
                  link={"/trackingtreatments"}
                  title={t("searchFindings.tabVuln.contentTab.tracking.title")}
                  tooltip={t(
                    "searchFindings.tabVuln.contentTab.tracking.tooltip"
                  )}
                />
              ) : undefined}
            </div>
            <Route path={"/details"}>
              <AdditionalInfo
                canRetrieveHacker={canDisplayHacker}
                onClose={onClose}
                vulnerability={currentRow}
              />
            </Route>
            <Route path={"/treatments"}>
              <UpdateDescription
                findingId={findingId}
                groupName={groupName}
                handleClearSelected={clearSelectedVulns}
                handleCloseModal={onClose}
                vulnerabilities={[currentRow]}
              />
            </Route>
            <Route path={"/trackingtreatments"}>
              <TreatmentTracking
                historicTreatment={currentRow.historicTreatment}
                onClose={onClose}
              />
            </Route>
          </MemoryRouter>
        )}
      </UpdateDescriptionContext.Provider>
    </Modal>
  );
};

export { IAdditionalInformationModal, AdditionalInformation };
