/* tslint:disable:jsx-no-multiline-js
 *
 * Disabling this rule is necessary for accessing render props from
 * apollo components
 */
import { MutationFunction, MutationResult, QueryResult } from "@apollo/react-common";
import { Mutation, Query } from "@apollo/react-components";
import { ApolloError } from "apollo-client";
import { GraphQLError } from "graphql";
import _ from "lodash";
import mixpanel from "mixpanel-browser";
import React from "react";
import { Glyphicon } from "react-bootstrap";
import { useParams } from "react-router";
/* tslint:disable-next-line: no-submodule-imports
 * Disabling this rule is necessary for allowing the import of the needed
 * language since the use of the light build
 */
import language from "react-syntax-highlighter/dist/esm/languages/hljs/python";
/* tslint:disable-next-line: no-submodule-imports
 * Disabling this rule is necessary for allowing the import light build
 */
import SyntaxHighlighter from "react-syntax-highlighter/dist/esm/light";
// tslint:disable-next-line no-submodule-imports
import { default as monokaiSublime } from "react-syntax-highlighter/dist/esm/styles/hljs/monokai-sublime";
import { Field, InjectedFormProps } from "redux-form";

import { Button } from "components/Button";
import { FluidIcon } from "components/FluidIcon";
import { GenericForm } from "scenes/Dashboard/components/GenericForm";
import {
  REMOVE_EVIDENCE_MUTATION,
  UPDATE_EVIDENCE_MUTATION,
} from "scenes/Dashboard/containers/EvidenceView/queries";
import { GET_FINDING_EXPLOIT } from "scenes/Dashboard/containers/ExploitView/queries";
import { default as globalStyle } from "styles/global.css";
import { ButtonToolbarRow, FormGroup } from "styles/styledComponents";
import { authContext, IAuthContext } from "utils/auth";
import { Can } from "utils/authz/Can";
import { FileInput } from "utils/forms/fields";
import { Logger } from "utils/logger";
import { msgError } from "utils/notifications";
import { translate } from "utils/translations/translate";
import { required, validExploitFile } from "utils/validations";

const exploitView: React.FC = (): JSX.Element => {
  SyntaxHighlighter.registerLanguage("python", language);
  const { findingId } = useParams<{ findingId: string }>();
  const { userName }: IAuthContext = React.useContext(authContext);

  const onMount: (() => void) = (): void => {
    mixpanel.track("FindingExploit", { User: userName });
  };
  React.useEffect(onMount, []);

  const [isEditing, setEditing] = React.useState(false);
  const handleEditClick: (() => void) = (): void => { setEditing(!isEditing); };

  const handleErrors: ((error: ApolloError) => void) = (
    { graphQLErrors }: ApolloError,
  ): void => {
    graphQLErrors.forEach((error: GraphQLError): void => {
      msgError(translate.t("group_alerts.error_textsad"));
      Logger.warning("An error occurred loading finding exploit", error);
    });
  };

  return (
    <React.StrictMode>
      <Query query={GET_FINDING_EXPLOIT} variables={{ findingId }} onError={handleErrors}>
        {({ data, refetch }: QueryResult): JSX.Element => {
          if (_.isUndefined(data) || _.isEmpty(data)) { return <React.Fragment />; }

          const handleUpdateResult: (() => void) = (): void => {
            void refetch();
          };
          const handleUpdateError: ((updateError: ApolloError) => void) = (updateError: ApolloError): void => {
            updateError.graphQLErrors.forEach(({ message }: GraphQLError): void => {
              switch (message) {
                case "Exception - Invalid File Size":
                  msgError(translate.t("validations.file_size", { count: 1 }));
                  break;
                case "Exception - Invalid File Type":
                  msgError(translate.t("group_alerts.file_type_py"));
                  break;
                default:
                  msgError(translate.t("group_alerts.error_textsad"));
                  Logger.warning("An error occurred updating exploit", updateError);
              }
            });
          };

          const handleRemoveErrors: ((removeError: ApolloError) => void) = (removeError: ApolloError): void => {
            msgError(translate.t("group_alerts.error_textsad"));
            Logger.warning("An error occurred removing exploit", removeError);
          };

          return (
            <React.Fragment>
              <ButtonToolbarRow>
                <Can do="backend_api_mutations_update_evidence_mutate">
                  <Button onClick={handleEditClick}>
                    <FluidIcon icon="edit" />&nbsp;{translate.t("search_findings.tab_severity.editable")}
                  </Button>
                </Can>
              </ButtonToolbarRow>
              <br />
              {isEditing ? (
                <Mutation
                  mutation={UPDATE_EVIDENCE_MUTATION}
                  onCompleted={handleUpdateResult}
                  onError={handleUpdateError}
                >
                  {(updateExploit: MutationFunction, updateRes: MutationResult): JSX.Element => {
                    const handleSubmit: ((values: { filename: FileList }) => void) = (
                      values: { filename: FileList },
                    ): void => {
                      setEditing(false);
                      void updateExploit({ variables: { evidenceId: "EXPLOIT", file: values.filename[0], findingId } });
                    };

                    return (
                      <GenericForm name="exploit" onSubmit={handleSubmit}>
                        {({ pristine }: InjectedFormProps): React.ReactNode => (
                          <React.Fragment>
                            <ButtonToolbarRow>
                              <div>
                                <FormGroup>
                                  <Field
                                    accept=".exp, .py"
                                    component={FileInput}
                                    id="exploitFile"
                                    name="filename"
                                    validate={[required, validExploitFile]}
                                  />
                                </FormGroup>
                              </div>
                              <div>
                                <Button type="submit" disabled={pristine || updateRes.loading}>
                                  <Glyphicon glyph="cloud-upload" />
                                  &nbsp;{translate.t("search_findings.tab_evidence.update")}
                                </Button>
                              </div>
                            </ButtonToolbarRow>
                            {isEditing && !_.isEmpty(data.finding.exploit) ? (
                              <Mutation
                                mutation={REMOVE_EVIDENCE_MUTATION}
                                onCompleted={handleUpdateResult}
                                onError={handleRemoveErrors}
                              >
                                {(removeExploit: MutationFunction, removeRes: MutationResult): JSX.Element => {
                                  const handleRemoveClick: (() => void) = (): void => {
                                    mixpanel.track("RemoveExploit", { User: userName });
                                    setEditing(false);
                                    void removeExploit({ variables: { evidenceId: "EXPLOIT", findingId } });
                                  };

                                  return (
                                    <ButtonToolbarRow>
                                      <Button onClick={handleRemoveClick} disabled={removeRes.loading}>
                                        <FluidIcon icon="delete" />
                                        &nbsp;{translate.t("search_findings.tab_evidence.remove")}
                                      </Button>
                                    </ButtonToolbarRow>
                                  );
                                }}
                              </Mutation>
                            ) : undefined}
                          </React.Fragment>
                        )}
                      </GenericForm>
                    );
                  }}
                </Mutation>
              ) : undefined}
              {_.isEmpty(data.finding.exploit)
                ? (
                  <div className={globalStyle["no-data"]}>
                    <Glyphicon glyph="console" />
                    <p>{translate.t("group.findings.exploit.no_data")}</p>
                  </div>
                ) : (
                  <SyntaxHighlighter style={monokaiSublime} language="python" showLineNumbers={true} wrapLines={true}>
                    {data.finding.exploit}
                  </SyntaxHighlighter>
                )}
            </React.Fragment>
          );
        }}
      </Query>
    </React.StrictMode>
  );
};

export { exploitView as ExploitView };
