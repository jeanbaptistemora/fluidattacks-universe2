# pylint: disable=invalid-name
"""
This migration removes the lastVulnerability attribute from the finding table

Execution Time:    2021-01-19 at 12:18:58 UTC-05
Finalization Time: 2021-01-19 at 12:31:52 UTC-05
"""
# Standard library
from typing import (
    Dict,
    cast,
)

# Third party libraries
from aioextensions import (
    collect,
    run,
)

# Local libraries
from custom_types import Finding as FindingType
from dynamodb import operations_legacy as dynamodb_ops
from findings import dal as findings_dal


FINDINGS_TABLE = 'FI_findings'


async def remove_last_vulnerability(
    finding: Dict[str, FindingType],
) -> bool:
    finding_id: str = cast(str, finding['finding_id'])
    success = cast(bool, await findings_dal.update(
        finding_id,
        {'lastVulnerability': None}
    ))
    print(f'finding {finding_id} was updated')

    return success


async def main() -> None:
    scan_attrs = {
        'ProjectionExpression': ','.join({
            'finding_id',
            'finding',
            'affected_systems'
        })
    }
    findings = await dynamodb_ops.scan(FINDINGS_TABLE, scan_attrs)
    # We don't care about wiped findings
    findings = [
        finding
        for finding in findings
        if not (
            finding.get('finding') == 'WIPED' or
            finding.get('affected_systems') == 'Masked'
        )
    ]
    success = all(await collect(
        [
            remove_last_vulnerability(finding)
            for finding in findings
        ],
        workers=64
    ))

    print(f'Success: {success}')


if __name__ == '__main__':
    run(main())
