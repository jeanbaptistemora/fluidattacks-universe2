from . import (
    get_result,
)
from custom_exceptions import (
    ExpectedVulnToBeOfLinesType,
    InvalidVulnCommitHash,
    InvalidVulnerabilityAlreadyExists,
    InvalidVulnSpecific,
    InvalidVulnWhere,
)
import pytest
from typing import (
    Any,
    Dict,
)

# Constants
STAKEHOLDER_GOOD = "admin@gmail.com"
VULNERABILITY_COMMIT_GOOD = "12654acf06e5a66913779d1298bbf76063bacecd"
VULNERABILITY_ID_GOOD = "be09edb7-cd5c-47ed-bee4-97c645acdce8"
VULNERABILITY_WHERE_GOOD = "a/b"
VULNERABILITY_SPECIFIC_GOOD = "10"


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_good_user_good_vuln() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert (
        result["errors"][0]["message"] == InvalidVulnerabilityAlreadyExists.msg
    )
    result = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where=VULNERABILITY_WHERE_GOOD + "-unique",
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert result["data"]["updateVulnerabilityCommit"]["success"]


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_good_user_bad_commit() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit="0123456",
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert result["errors"][0]["message"] == InvalidVulnCommitHash.msg
    result = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit="x" * 40,
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert result["errors"][0]["message"] == InvalidVulnCommitHash.msg


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_good_user_bad_id() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id="not-exists",
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert (
        result["errors"][0]["message"] == "Exception - Vulnerability not found"
    )


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_good_user_bad_where() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where="a\\b",
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert result["errors"][0]["message"] == InvalidVulnWhere.msg


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_good_user_bad_specific() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific="string",
    )
    assert result["errors"][0]["message"] == InvalidVulnSpecific.msg


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_good_user_bad_type() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder=STAKEHOLDER_GOOD,
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id="77b88be2-37c8-429b-a519-029b1c32fdcd",
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert result["errors"][0]["message"] == ExpectedVulnToBeOfLinesType.msg


@pytest.mark.asyncio
@pytest.mark.resolver_test_group("update_vulnerability_commit")
async def test_bad_user_good_vuln() -> None:
    result: Dict[str, Any] = await get_result(
        stakeholder="someone-without-access@gmail.com",
        vulnerability_commit=VULNERABILITY_COMMIT_GOOD,
        vulnerability_id=VULNERABILITY_ID_GOOD,
        vulnerability_where=VULNERABILITY_WHERE_GOOD,
        vulnerability_specific=VULNERABILITY_SPECIFIC_GOOD,
    )
    assert "errors" in result
    assert result["errors"][0]["message"] == "Access denied"
