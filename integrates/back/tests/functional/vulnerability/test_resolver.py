# Standard libraries
import pytest
from typing import (
    Any,
    Dict,
)

# Local libraries
from . import query


@pytest.mark.asyncio
@pytest.mark.resolver_test_group('vulnerability')
@pytest.mark.parametrize(
    ['email'],
    [
        ['admin@gmail.com'],
        ['analyst@gmail.com'],
        ['closer@gmail.com'],
    ]
)
async def test_get_vulnerability(populate: bool, email: str):
    assert populate
    finding_id: str = '475041513'
    vulnerability_id: str = 'be09edb7-cd5c-47ed-bee4-97c645acdce8'
    analyst: str = 'test1@gmail.com'
    expected_output: Dict[str, Any] = {
        'finding_id': finding_id,
        'UUID': vulnerability_id,
        'analyst': analyst,
        'historic_state': [
            {
                'date': '2018-04-07 19:45:11',
                'analyst': analyst,
                'source': 'integrates',
                'state': 'open',
                'approval_status': 'APPROVED',
            },
        ],
        'current_state': 'open',
        'historic_treatment': [
            {
                'date': '2018-04-07 17:45:11',
                'treatment': 'NEW',
            },
        ],
        'historic_verification': [
            {
                'date': '2018-04-08 19:45:11',
                'status': 'REQUESTED',
            },
        ],
        'vuln_type': 'ports',
        'where': '192.168.1.20',
        'specific': '9999',
        'severity': '',
        'tag': '',
        'tags': [],
        'verification': 'Requested',
    }
    result: Dict[str, str] = await query(
        user=email,
        vulnerability=vulnerability_id,
    )
    assert 'errors' not in result
    assert result['data']['vulnerability']['findingId'] == expected_output['finding_id']
    assert result['data']['vulnerability']['id'] == expected_output['UUID']
    assert result['data']['vulnerability']['analyst'] == expected_output['analyst']
    assert result['data']['vulnerability']['historicState'] == expected_output['historic_state']
    assert result['data']['vulnerability']['historicTreatment'] == expected_output['historic_treatment']
    assert result['data']['vulnerability']['historicVerification'] == expected_output['historic_verification']
    assert result['data']['vulnerability']['vulnType'] == expected_output['vuln_type']
    assert result['data']['vulnerability']['where'] == expected_output['where']
    assert result['data']['vulnerability']['specific'] == expected_output['specific']
    assert result['data']['vulnerability']['currentState'] == expected_output['current_state']
    assert result['data']['vulnerability']['currentApprovalStatus'] == expected_output['historic_state'][-1]['approval_status']
    assert result['data']['vulnerability']['remediated'] == True
    assert result['data']['vulnerability']['severity'] == ''
    assert result['data']['vulnerability']['source'] == expected_output['historic_state'][-1]['source']
    assert result['data']['vulnerability']['tag'] == ''
    assert result['data']['vulnerability']['tags'] == []
    assert result['data']['vulnerability']['verification'] == expected_output['verification']
