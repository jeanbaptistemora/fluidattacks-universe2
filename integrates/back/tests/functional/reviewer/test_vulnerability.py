# Standard libraries
import os
import pytest

# Third party libraries
from starlette.datastructures import UploadFile

# Local libraries
from backend.api import get_new_context
from backend.utils import datetime as datetime_utils
from back.tests.functional.reviewer.utils import get_result


@pytest.mark.asyncio
@pytest.mark.resolver_test_group('old')
async def test_vulnerability():
    context = get_new_context()
    today = datetime_utils.get_as_str(
        datetime_utils.get_now(),
        date_format='%Y-%m-%d'
    )
    cwe = '200'
    description = 'This is pytest created draft'
    group_name = 'unittesting'
    recommendation = 'Solve this finding'
    requirements = 'REQ.0001. Apply filters'
    risk = 'This is pytest created draft'
    threat = 'Attacker'
    title = 'F001. Very serious vulnerability'
    draft_type = 'SECURITY'
    query = f'''
        mutation {{
            createDraft(
                cwe: "{cwe}",
                description: "{description}",
                projectName: "{group_name}",
                recommendation: "{recommendation}",
                requirements: "{requirements}",
                risk: "{risk}",
                threat: "{threat}",
                title: "{title}",
                type: {draft_type}
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(
        data,
        stakeholder='integratesanalyst@fluidattacks.com',
        context=context
    )
    assert 'errors' not in result
    assert 'success' in result['data']['createDraft']
    assert result['data']['createDraft']['success']

    context = get_new_context()
    query = f'''
        query {{
            project(projectName: "{group_name}"){{
                drafts {{
                    id
                    title
                }}
                stakeholders {{
                    email
                    firstLogin
                    lastLogin
                    phoneNumber
                    responsibility
                    role
                }}
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    draft = [draft for draft in result['data']['project']['drafts'] if draft['title'] == title][0]
    draft_id = draft['id']

    context = get_new_context()
    filename = os.path.dirname(os.path.abspath(__file__))
    filename = os.path.join(filename, '../../unit/mock/test-vulns.yaml')
    with open(filename, 'rb') as test_file:
        uploaded_file = UploadFile(test_file.name, test_file, 'text/x-yaml')
        query = '''
            mutation UploadFileMutation(
                $file: Upload!, $findingId: String!
            ) {
                uploadFile (
                    file: $file,
                    findingId: $findingId
                ) {
                    success
                }
            }
        '''
        variables = {
            'file': uploaded_file,
            'findingId': draft_id,
        }
        data = {'query': query, 'variables': variables}
        result = await get_result(data, context=context)
    assert 'errors' not in result
    assert result['data']['uploadFile']['success']

    context = get_new_context()
    query = f'''
        mutation {{
            updateSeverity (
            findingId: "{draft_id}",
            data: {{
                attackComplexity: 0.77, attackVector: 0.62,
                availabilityImpact: "0", availabilityRequirement: "1",
                confidentialityImpact: "0", confidentialityRequirement: "1",
                cvssVersion: "3.1", exploitability: 0.91, id: "{draft_id}",
                integrityImpact: "0.22", integrityRequirement: "1",
                modifiedAttackComplexity: 0.77, modifiedAttackVector: 0.62,
                modifiedAvailabilityImpact: "0",
                modifiedConfidentialityImpact: "0",
                modifiedIntegrityImpact: "0.22",
                modifiedPrivilegesRequired: "0.62",
                modifiedSeverityScope: 0, modifiedUserInteraction: 0.85,
                privilegesRequired: "0.62", remediationLevel: "0.97",
                reportConfidence: "0.92",
                severity: "2.9", severityScope: 0, userInteraction: 0.85
            }}
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(
        data,
        stakeholder='integratesanalyst@fluidattacks.com',
        context=context
    )
    assert 'errors' not in result
    assert 'success' in result['data']['updateSeverity']
    assert result['data']['updateSeverity']['success']

    context = get_new_context()
    query = '''
        mutation UpdateEvidenceMutation(
            $evidenceId: EvidenceType!, $file: Upload!, $findingId: String!
        ) {
            updateEvidence(
                evidenceId: $evidenceId, file: $file, findingId: $findingId
            ) {
                success
            }
        }
    '''
    filename = os.path.dirname(os.path.abspath(__file__))
    filename = os.path.join(filename, '../../unit/mock/test-anim.gif')
    with open(filename, 'rb') as test_file:
        uploaded_file = UploadFile(test_file.name, test_file, 'image/gif')
        variables = {
            'evidenceId': 'ANIMATION',
            'findingId': draft_id,
            'file': uploaded_file
        }
        data = {'query': query, 'variables': variables}
        result = await get_result(
            data,
            stakeholder='integratesanalyst@fluidattacks.com',
            context=context
        )
        assert 'errors' not in result
        assert 'success' in result['data']['updateEvidence']
        assert result['data']['updateEvidence']['success']

    context = get_new_context()
    query = f'''
        mutation {{
            submitDraft(findingId: "{draft_id}") {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(
        data,
        stakeholder='integratesanalyst@fluidattacks.com',
        context=context
    )
    assert 'errors' not in result
    assert result['data']['submitDraft']['success']

    context = get_new_context()
    query = f'''
        mutation {{
            approveDraft(draftId: "{draft_id}") {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(
        data,
        stakeholder='integratesreviewer@fluidattacks.com',
        context=context
    )
    assert 'errors' not in result
    assert result['data']['approveDraft']['success']

    context = get_new_context()
    finding_id = draft_id
    query = f'''
        query {{
            finding(identifier: "{finding_id}"){{
                vulnerabilities{{
                    id
                    where
                }}
                openVulnerabilities
                closedVulnerabilities
                state
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    assert result['data']['finding']['openVulnerabilities'] == 1
    assert result['data']['finding']['closedVulnerabilities'] == 2
    assert result['data']['finding']['state'] == 'open'
    vulns = result['data']['finding']['vulnerabilities']
    vuln_uuid = [x for x in vulns if x['where'] == 'https://example.com'][0]['id']

    context = get_new_context()
    query = f'''
        mutation {{
            requestVerificationVuln(
                findingId: "{finding_id}",
                justification: "this is a comenting test of a request verification in vulns",
                vulnerabilities:
                    ["{vuln_uuid}"]
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    assert result['data']['requestVerificationVuln']['success']

    context = get_new_context()
    query = f'''
        mutation {{
            verifyRequestVuln(
                findingId: "{finding_id}",
                justification: "Vuln verified",
                openVulns: ["{vuln_uuid}"],
                closedVulns: []
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Access denied'

    context = get_new_context()
    query = f'''
            mutation {{
                requestZeroRiskVuln(
                    findingId: "{finding_id}",
                    justification: "request zero risk vuln",
                    vulnerabilities:
                        ["{vuln_uuid}"]
                ) {{
                    success
                }}
            }}
        '''
    data = {'query': query}
    result = await get_result(
        data,
        stakeholder='integratescustomer@gmail.com',
        context=context
    )
    assert 'errors' not in result
    assert 'success' in result['data']['requestZeroRiskVuln']
    assert result['data']['requestZeroRiskVuln']['success']

    context = get_new_context()
    query = f'''
            mutation {{
                rejectZeroRiskVuln(
                    findingId: "{finding_id}",
                    justification: "reject zero risk vuln",
                    vulnerabilities:
                        ["{vuln_uuid}"]
                ) {{
                    success
                }}
            }}
        '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    assert 'success' in result['data']['rejectZeroRiskVuln']
    assert result['data']['rejectZeroRiskVuln']['success']

    context = get_new_context()
    query = f'''
            mutation {{
                requestZeroRiskVuln(
                    findingId: "{finding_id}",
                    justification: "request zero risk vuln",
                    vulnerabilities:
                        ["{vuln_uuid}"]
                ) {{
                    success
                }}
            }}
        '''
    data = {'query': query}
    result = await get_result(
        data,
        stakeholder='integratesuser@gmail.com',
        context=context
    )
    assert 'errors' not in result
    assert 'success' in result['data']['requestZeroRiskVuln']
    assert result['data']['requestZeroRiskVuln']['success']

    context = get_new_context()
    query = f'''
            mutation {{
                confirmZeroRiskVuln(
                    findingId: "{finding_id}",
                    justification: "confirm zero risk vuln",
                    vulnerabilities:
                        ["{vuln_uuid}"]
                ) {{
                    success
                }}
            }}
        '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    assert 'success' in result['data']['confirmZeroRiskVuln']
    assert result['data']['confirmZeroRiskVuln']['success']

    context = get_new_context()
    query = f'''
        query {{
            vulnerability(uuid: "{vuln_uuid}") {{
                analyst
                currentApprovalStatus
                currentState
                findingId
                historicState
                historicVerification {{
                    date
                    status
                }}
                historicZeroRisk {{
                    date
                    status
                }}
                id
                remediated
                severity
                source
                specific
                tag
                tags
                verification
                vulnType
                where
                zeroRisk
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    assert result['data']['vulnerability']['analyst'] == 'integratesreviewer@fluidattacks.com'
    assert result['data']['vulnerability']['currentApprovalStatus'] == ''
    assert result['data']['vulnerability']['currentState'] == 'open'
    assert result['data']['vulnerability']['findingId'] == finding_id
    historic_state = result['data']['vulnerability']['historicState']
    for index in range(len(historic_state)):
        historic_state[index]['date'] = (
            historic_state[index]['date'][:-9]
        )
    assert historic_state == [
        {
            'date': today,
            'analyst': 'integratesreviewer@fluidattacks.com',
            'source': 'integrates',
            'state': 'open',
        }
    ]
    historic_verification = result['data']['vulnerability']['historicVerification']
    for index in range(len(historic_verification)):
        historic_verification[index]['date'] = (
            historic_verification[index]['date'][:-9]
        )
    assert historic_verification == [
        {
            'date': today,
            'status': 'REQUESTED'
        }
    ]
    historic_zero_risk = result['data']['vulnerability']['historicZeroRisk']
    for index in range(len(historic_zero_risk)):
        historic_zero_risk[index]['date'] = (
            historic_zero_risk[index]['date'][:-9]
        )
    assert historic_zero_risk == [
        {
            'date': today,
            'status': 'REQUESTED'
        },
        {
            'date': today,
            'status': 'REJECTED'
        },
        {
            'date': today,
            'status': 'REQUESTED'
        },
        {
            'date': today,
            'status': 'CONFIRMED'
        }
    ]
    assert result['data']['vulnerability']['id'] == vuln_uuid
    assert result['data']['vulnerability']['remediated'] == True
    assert result['data']['vulnerability']['severity'] == ''
    assert result['data']['vulnerability']['source'] == 'integrates'
    assert result['data']['vulnerability']['specific'] == 'phone'
    assert result['data']['vulnerability']['tag'] == ''
    assert result['data']['vulnerability']['tags'] == []
    assert result['data']['vulnerability']['verification'] == 'Requested'
    assert result['data']['vulnerability']['vulnType'] == 'inputs'
    assert result['data']['vulnerability']['where'] == 'https://example.com'
    assert result['data']['vulnerability']['zeroRisk'] == 'Confirmed'

    finding_id = draft_id
    query = f'''
        query {{
            finding(identifier: "{finding_id}"){{
                state
            }}
        }}
    '''
    data = {'query': query}
    result = await get_result(data, context=context)
    assert 'errors' not in result
    assert result['data']['finding']['state'] == 'closed'
