from aiodataloader import (
    DataLoader,
)
from contextlib import (
    suppress,
)
from custom_exceptions import (
    VulnNotFound,
)
from db_model.vulnerabilities.types import (
    Vulnerability,
    VulnerabilityState,
    VulnerabilityTreatment,
    VulnerabilityVerification,
    VulnerabilityZeroRisk,
)
import logging
from newutils.vulnerabilities import (
    format_vulnerability,
    format_vulnerability_state,
    format_vulnerability_treatment,
    format_vulnerability_verification,
    format_vulnerability_zero_risk,
    get_optional,
)
from settings.logger import (
    NOEXTRA,
)
from typing import (
    Any,
    Dict,
    List,
    Tuple,
)
from vulnerabilities import (
    domain as vulns_domain,
)

LOGGER = logging.getLogger(__name__)
LOGGER_TRANSACTIONAL = logging.getLogger("transactional")


class VulnerabilityLoader(DataLoader):
    # pylint: disable=no-self-use,method-hidden
    async def batch_load_fn(
        self, vuln_uuids: List[str]
    ) -> List[Dict[str, Any]]:
        return await vulns_domain.get_by_vulnerabilities_ids(vuln_uuids)


class VulnerabilityTypedLoader(DataLoader):
    def __init__(self, new_loader: DataLoader, old_loader: DataLoader) -> None:
        super().__init__()
        self.new_loader = new_loader
        self.old_loader = old_loader

    def clear(self, key: str) -> DataLoader:
        self.new_loader.clear(key)
        self.old_loader.clear(key)
        return super().clear(key)

    # pylint: disable=method-hidden
    async def batch_load_fn(self, ids: List[str]) -> Tuple[Vulnerability, ...]:
        with suppress(VulnNotFound):
            new_vulns = await self.new_loader.load_many(ids)
            LOGGER_TRANSACTIONAL.info(
                ":".join(["Migration: Loading vulns", *ids]), **NOEXTRA
            )
            return new_vulns

        return tuple(
            format_vulnerability(vulnerability)
            for vulnerability in await self.old_loader.load_many(ids)
        )


class VulnerabilityHistoricStateLoader(DataLoader):
    def __init__(self, new_loader: DataLoader, dataloader: DataLoader) -> None:
        super().__init__()
        self.new_loader = new_loader
        self.dataloader = dataloader

    def clear(self, key: str) -> DataLoader:
        self.new_loader.clear(key)
        self.dataloader.clear(key)
        return super().clear(key)

    # pylint: disable=method-hidden
    async def batch_load_fn(
        self, ids: Tuple[str, ...]
    ) -> Tuple[Tuple[VulnerabilityState, ...], ...]:
        new_historics = await self.new_loader.load_many(ids)
        empty = tuple(historic for historic in new_historics if not historic)
        if not empty:
            LOGGER_TRANSACTIONAL.info(
                ":".join(["Migration: Loading vuln states", *ids]), **NOEXTRA
            )
            return new_historics

        return tuple(
            tuple(
                format_vulnerability_state(state)
                for state in vulnerability["historic_state"]
            )
            for vulnerability in await self.dataloader.load_many(ids)
        )


class VulnerabilityHistoricTreatmentLoader(DataLoader):
    def __init__(self, new_loader: DataLoader, dataloader: DataLoader) -> None:
        super().__init__()
        self.new_loader = new_loader
        self.dataloader = dataloader

    def clear(self, key: str) -> DataLoader:
        self.new_loader.clear(key)
        self.dataloader.clear(key)
        return super().clear(key)

    # pylint: disable=method-hidden
    async def batch_load_fn(
        self, ids: Tuple[str, ...]
    ) -> Tuple[Tuple[VulnerabilityTreatment, ...], ...]:
        new_historics = await self.new_loader.load_many(ids)
        empty = tuple(historic for historic in new_historics if not historic)
        if not empty:
            LOGGER_TRANSACTIONAL.info(
                ":".join(["Migration: Loading vuln treatments", *ids]),
                **NOEXTRA,
            )
            return new_historics

        return tuple(
            tuple(
                format_vulnerability_treatment(treatment)
                for treatment in get_optional(
                    "historic_treatment", vulnerability, tuple()
                )
            )
            for vulnerability in await self.dataloader.load_many(ids)
        )


class VulnerabilityHistoricVerificationLoader(DataLoader):
    def __init__(self, new_loader: DataLoader, dataloader: DataLoader) -> None:
        super().__init__()
        self.new_loader = new_loader
        self.dataloader = dataloader

    def clear(self, key: str) -> DataLoader:
        self.new_loader.clear(key)
        self.dataloader.clear(key)
        return super().clear(key)

    # pylint: disable=method-hidden
    async def batch_load_fn(
        self, ids: Tuple[str, ...]
    ) -> Tuple[Tuple[VulnerabilityVerification, ...], ...]:
        new_historics = await self.new_loader.load_many(ids)
        empty = tuple(historic for historic in new_historics if not historic)
        if not empty:
            LOGGER_TRANSACTIONAL.info(
                ":".join(["Migration: Loading vuln verifications", *ids]),
                **NOEXTRA,
            )
            return new_historics

        return tuple(
            tuple(
                format_vulnerability_verification(verification)
                for verification in get_optional(
                    "historic_verification", vulnerability, tuple()
                )
            )
            for vulnerability in await self.dataloader.load_many(ids)
        )


class VulnerabilityHistoricZeroRiskLoader(DataLoader):
    def __init__(self, new_loader: DataLoader, dataloader: DataLoader) -> None:
        super().__init__()
        self.new_loader = new_loader
        self.dataloader = dataloader

    def clear(self, key: str) -> DataLoader:
        self.new_loader.clear(key)
        self.dataloader.clear(key)
        return super().clear(key)

    # pylint: disable=method-hidden
    async def batch_load_fn(
        self, ids: Tuple[str, ...]
    ) -> Tuple[Tuple[VulnerabilityZeroRisk, ...], ...]:
        new_historics = await self.new_loader.load_many(ids)
        empty = tuple(historic for historic in new_historics if not historic)
        if not empty:
            LOGGER_TRANSACTIONAL.info(
                ":".join(["Migration: Loading vuln zero risks", *ids]),
                **NOEXTRA,
            )
            return new_historics

        return tuple(
            tuple(
                format_vulnerability_zero_risk(zero_risk)
                for zero_risk in get_optional(
                    "historic_zero_risk", vulnerability, tuple()
                )
            )
            for vulnerability in await self.dataloader.load_many(ids)
        )
