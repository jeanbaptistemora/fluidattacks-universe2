from datetime import datetime, timedelta
import json
import os
import uuid
import pytest

from ariadne import graphql, graphql_sync
from freezegun import freeze_time
from jose import jwt
from starlette.datastructures import UploadFile

from backend.api import (
    apply_context_attrs,
    get_new_context
)
from backend import util

from backend.api.schema import SCHEMA
from backend.dal import (
    comment as comment_dal,
    finding as finding_dal,
)
from backend.domain import vulnerability as vuln_domain
from backend.exceptions import (
    VulnNotInFinding,
    VulnNotFound,
    AcceptionNotRequested,
    InvalidSchema,
    InvalidTreatmentManager,
)
from backend.utils import datetime as datetime_utils
from test_async.utils import create_dummy_session

pytestmark = pytest.mark.asyncio


async def _get_result_async(data, user='integratesmanager@gmail.com'):
    """Get result."""
    request = await create_dummy_session(user)
    request = apply_context_attrs(request)
    _, result = await graphql(SCHEMA, data, context_value=request)
    return result


async def test_vulnerability():
    vuln_uuid = '09afd608-aa53-4ccb-9094-0076181fa0ea'
    expected_output = {
        'finding_id': '475041513',
        'UUID': vuln_uuid,
        'vuln_type': 'ports',
        'specific': '3636',
        'where': '192.168.100.105',
        'historic_state': [{
            'date': '2019-09-13 09:58:38',
            'analyst': 'unittest@fluidattacks.com',
            'state': 'open',
        }],
        'historic_zero_risk': [
            {
                'date': '2018-09-28 10:32:58',
                'status': 'REQUESTED'
            },
            {
                'date': '2020-09-09 16:01:26',
                'status': 'CONFIRMED'
            }
        ],
        'zero_risk': 'Confirmed'
    }
    query = '''
        query {
            vulnerability(uuid: "$vuln_uuid") {
                findingId
                id
                vulnType
                specific
                where
                historicState
                historicZeroRisk {
                    date
                    status
                }
                zeroRisk
            }
        }
    '''.replace('$vuln_uuid', vuln_uuid)
    data = {'query': query}
    result = await _get_result_async(data)
    assert 'errors' not in result
    assert result['data']['vulnerability']['findingId'] == expected_output.get('finding_id')
    assert result['data']['vulnerability']['where'] == expected_output.get('where')
    assert result['data']['vulnerability']['historicState'] == expected_output.get('historic_state')
    assert result['data']['vulnerability']['historicZeroRisk'] == expected_output.get('historic_zero_risk')
    assert result['data']['vulnerability']['id'] == expected_output.get('UUID')
    assert result['data']['vulnerability']['specific'] == expected_output.get('specific')
    assert result['data']['vulnerability']['vulnType'] == expected_output.get('vuln_type')
    assert result['data']['vulnerability']['zeroRisk'] == expected_output.get('zero_risk')


@pytest.mark.changes_db
async def test_delete_tags():
    """Check for deleteTags mutation."""
    query = '''
        mutation {
            deleteTags(
                findingId: "463558592",
                vulnerabilities: [
                    "0a848781-b6a4-422e-95fa-692151e6a98e",
                    "3bcdb384-5547-4170-a0b6-3b397a245465"
                ]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(
        data, user='integratesuser@gmail.com')
    assert 'errors' not in result
    assert 'success' in result['data']['deleteTags']
    assert result['data']['deleteTags']['success']


@pytest.mark.changes_db
async def test_update_treatment_vuln():
    """Check for updateTreatmentVuln mutation."""
    query = '''
        mutation {
            updateTreatmentVuln (
                findingId: "422286126",
                vulnerabilityId: "80d6a69f-a376-46be-98cd-2fdedcffdcc0"
                externalBts: "http://test"
            ){
            success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(
        data, user='continuoushacking@gmail.com')
    assert 'errors' not in result
    assert 'success' in result['data']['updateTreatmentVuln']
    assert result['data']['updateTreatmentVuln']['success']


@pytest.mark.changes_db
async def test_request_verification():
    """Check for requestVerificationVuln mutation."""
    query = '''
        mutation {
            requestVerificationVuln(
                findingId: "436992569",
                justification: "this is a comenting test of a request verification in vulns",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "5ed5c3c0-9064-41f5-8ef2-5e1eeee62955"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data)
    assert 'errors' not in result
    assert 'success' in result['data']['requestVerificationVuln']
    vulnerability = await vuln_domain.get_by_finding('436992569', '5ed5c3c0-9064-41f5-8ef2-5e1eeee62955')
    assert vulnerability['historic_verification'][-1].get('status') == 'REQUESTED'
    vulnerability = await vuln_domain.get_by_finding('436992569', '5afb9a49-a359-48ce-80ee-79c145919275')
    assert vulnerability['historic_verification'][-1].get('status') == 'REQUESTED'


@pytest.mark.changes_db
async def test_verify_requested_vulns():
    """Check for verifyRequestVuln mutation."""
    query = '''
        mutation {
            verifyRequestVuln(
                findingId: "422286126",
                justification: "Vuln verified",
                openVulns: ["80d6a69f-a376-46be-98cd-2fdedcffdcc0"],
                closedVulns: []
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data)
    expected_error = 'Exception - Error verification not requested'
    assert 'errors' in result
    assert result['errors'][0]['message'] == expected_error


@pytest.mark.changes_db
@freeze_time("2019-12-01")
async def test_request_zero_risk_vuln():
    """Check for requestZeroRiskVuln mutation."""
    query = '''
        mutation {
            requestZeroRiskVuln(
                findingId: "436992569",
                justification: "request zero risk vuln",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "5ed5c3c0-9064-41f5-8ef2-5e1eeee62955"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratescustomer@gmail.com')
    assert 'errors' not in result
    assert 'success' in result['data']['requestZeroRiskVuln']
    assert result['data']['requestZeroRiskVuln']['success']

    comments = await comment_dal.get_comments('zero_risk', 436992569)
    assert len(comments) == 1
    assert comments[0]['content'] == 'request zero risk vuln'
    assert comments[0]['created'] == '2019-11-30 19:00:00'
    assert comments[0]['email'] == 'integratescustomer@gmail.com'
    assert comments[0]['finding_id'] == 436992569
    assert comments[0]['fullname'] == 'unit test'
    assert comments[0]['modified'] == '2019-11-30 19:00:00'
    comment_id = comments[0]['user_id']

    vulnerability = await vuln_domain.get_by_finding('436992569', '5ed5c3c0-9064-41f5-8ef2-5e1eeee62955')
    assert len(vulnerability['historic_zero_risk']) == 1
    assert vulnerability['historic_zero_risk'][-1].get('comment_id') == comment_id
    assert vulnerability['historic_zero_risk'][-1].get('date') == '2019-11-30 19:00:00'
    assert vulnerability['historic_zero_risk'][-1].get('email') == 'integratescustomer@gmail.com'
    assert vulnerability['historic_zero_risk'][-1].get('status') == 'REQUESTED'
    vulnerability = await vuln_domain.get_by_finding('436992569', '5afb9a49-a359-48ce-80ee-79c145919275')
    assert len(vulnerability['historic_zero_risk']) == 1
    assert vulnerability['historic_zero_risk'][-1].get('comment_id') == comment_id
    assert vulnerability['historic_zero_risk'][-1].get('date') == '2019-11-30 19:00:00'
    assert vulnerability['historic_zero_risk'][-1].get('email') == 'integratescustomer@gmail.com'
    assert vulnerability['historic_zero_risk'][-1].get('status') == 'REQUESTED'


@pytest.mark.changes_db
async def test_request_zero_risk_vuln_error_already_requested():
    """Check for already requested vuln with requestZeroRiskVuln mutation."""
    query = '''
        mutation {
            requestZeroRiskVuln(
                findingId: "436992569",
                justification: "request zero risk vuln",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "5ed5c3c0-9064-41f5-8ef2-5e1eeee62955"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data)
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Exception - Zero risk vulnerability is already requested'

    vulnerability = await vuln_domain.get_by_finding('436992569', '5ed5c3c0-9064-41f5-8ef2-5e1eeee62955')
    assert len(vulnerability['historic_zero_risk']) == 1
    vulnerability = await vuln_domain.get_by_finding('436992569', '5afb9a49-a359-48ce-80ee-79c145919275')
    assert len(vulnerability['historic_zero_risk']) == 1

    comments = await comment_dal.get_comments('zero_risk', 436992569)
    assert len(comments) == 1


@pytest.mark.changes_db
async def test_request_zero_risk_vuln_error_vuln_not_in_finding():
    """Check for vuln not in finding with requestZeroRiskVuln mutation."""
    query = '''
        mutation {
            requestZeroRiskVuln(
                findingId: "436992569",
                justification: "request zero risk vuln",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "80d6a69f-a376-46be-98cd-2fdedcffdcc0"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == str(VulnNotInFinding())

    vulnerability = await vuln_domain.get_by_finding('436992569', '5ed5c3c0-9064-41f5-8ef2-5e1eeee62955')
    assert len(vulnerability['historic_zero_risk']) == 1
    vulnerability = await vuln_domain.get_by_finding('436992569', '5afb9a49-a359-48ce-80ee-79c145919275')
    assert len(vulnerability['historic_zero_risk']) == 1

    comments = await comment_dal.get_comments('zero_risk', 436992569)
    assert len(comments) == 1


async def test_request_zero_risk_vuln_error_invalid_justification_lentgh():
    """Check for invalid justification lentgh with requestZeroRiskVuln mutation."""
    justification = 'x' * 2001
    query = f'''
        mutation {{
            requestZeroRiskVuln(
                findingId: "436992569",
                justification: "{justification}",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "5ed5c3c0-9064-41f5-8ef2-5e1eeee62952"]
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Exception - Justification must have a maximum of 2000 characters'



@pytest.mark.changes_db
@freeze_time("2019-12-01")
async def test_confirm_zero_risk_vuln():
    """Check for confirmZeroRiskVuln mutation."""
    query = '''
        mutation {
            confirmZeroRiskVuln(
                findingId: "463558592",
                justification: "confirm zero risk vuln",
                vulnerabilities:
                    ["54b94fa0-8f4f-4b10-a38a-6e848a9eb0c6",
                        "6f023c26-5b10-4ded-aa27-bb563c2206ab"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesreviewer@fluidattacks.com')
    assert 'errors' not in result
    assert 'success' in result['data']['confirmZeroRiskVuln']
    assert result['data']['confirmZeroRiskVuln']['success']

    comments = await comment_dal.get_comments('zero_risk', 463558592)
    assert len(comments) == 1
    assert comments[0]['content'] == 'confirm zero risk vuln'
    assert comments[0]['created'] == '2019-11-30 19:00:00'
    assert comments[0]['email'] == 'integratesreviewer@fluidattacks.com'
    assert comments[0]['finding_id'] == 463558592
    assert comments[0]['fullname'] == 'unit test'
    assert comments[0]['modified'] == '2019-11-30 19:00:00'
    comment_id = comments[0]['user_id']

    vulnerability = await vuln_domain.get_by_finding('463558592', '6f023c26-5b10-4ded-aa27-bb563c2206ab')
    assert len(vulnerability['historic_zero_risk']) == 2
    assert vulnerability['historic_zero_risk'][-1].get('comment_id') == comment_id
    assert vulnerability['historic_zero_risk'][-1].get('date') == '2019-11-30 19:00:00'
    assert vulnerability['historic_zero_risk'][-1].get('email') == 'integratesreviewer@fluidattacks.com'
    assert vulnerability['historic_zero_risk'][-1].get('status') == 'CONFIRMED'
    vulnerability = await vuln_domain.get_by_finding('463558592', '54b94fa0-8f4f-4b10-a38a-6e848a9eb0c6')
    assert len(vulnerability['historic_zero_risk']) == 2
    assert vulnerability['historic_zero_risk'][-1].get('comment_id') == comment_id
    assert vulnerability['historic_zero_risk'][-1].get('date') == '2019-11-30 19:00:00'
    assert vulnerability['historic_zero_risk'][-1].get('email') == 'integratesreviewer@fluidattacks.com'
    assert vulnerability['historic_zero_risk'][-1].get('status') == 'CONFIRMED'


@pytest.mark.changes_db
async def test_confirm_zero_risk_vuln_error_not_requested():
    """Check for not requested zero risk vuln with confirmZeroRiskVuln mutation."""
    query = '''
        mutation {
            confirmZeroRiskVuln(
                findingId: "463558592",
                justification: "confirm zero risk vuln",
                vulnerabilities:
                    ["54b94fa0-8f4f-4b10-a38a-6e848a9eb0c6",
                        "6f023c26-5b10-4ded-aa27-bb563c2206ab"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data)
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Exception - Zero risk vulnerability is not requested'

    vulnerability = await vuln_domain.get_by_finding('463558592', '6f023c26-5b10-4ded-aa27-bb563c2206ab')
    assert len(vulnerability['historic_zero_risk']) == 2
    vulnerability = await vuln_domain.get_by_finding('463558592', '54b94fa0-8f4f-4b10-a38a-6e848a9eb0c6')
    assert len(vulnerability['historic_zero_risk']) == 2

    comments = await comment_dal.get_comments('zero_risk', 463558592)
    assert len(comments) == 1


@pytest.mark.changes_db
async def test_confirm_zero_risk_vuln_error_vuln_not_in_finding():
    """Check for vuln not in finding with confirmZeroRiskVuln mutation."""
    query = '''
        mutation {
            confirmZeroRiskVuln(
                findingId: "463558592",
                justification: "confirm zero risk vuln",
                vulnerabilities:
                    ["54b94fa0-8f4f-4b10-a38a-6e848a9eb0c6",
                        "72bb8607-c259-4781-9599-185aac02b3cc"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesreviewer@fluidattacks.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == str(VulnNotInFinding())

    vulnerability = await vuln_domain.get_by_finding('463558592', '6f023c26-5b10-4ded-aa27-bb563c2206ab')
    assert len(vulnerability['historic_zero_risk']) == 2
    vulnerability = await vuln_domain.get_by_finding('463558592', '54b94fa0-8f4f-4b10-a38a-6e848a9eb0c6')
    assert len(vulnerability['historic_zero_risk']) == 2

    comments = await comment_dal.get_comments('zero_risk', 463558592)
    assert len(comments) == 1


async def test_confirm_zero_risk_vuln_error_invalid_justification_lentgh():
    """Check for invalid justification lentgh with confirmZeroRiskVuln mutation."""
    justification = 'x' * 2001
    query = f'''
        mutation {{
            confirmZeroRiskVuln(
                findingId: "436992569",
                justification: "{justification}",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "5ed5c3c0-9064-41f5-8ef2-5e1eeee62952"]
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesreviewer@fluidattacks.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Exception - Justification must have a maximum of 2000 characters'


@pytest.mark.changes_db
@freeze_time("2019-12-01")
async def test_reject_zero_risk_vuln():
    """Check for rejectZeroRiskVuln mutation."""
    query = '''
        mutation {
            rejectZeroRiskVuln(
                findingId: "463558592",
                justification: "reject zero risk vuln",
                vulnerabilities:
                    ["3bcdb384-5547-4170-a0b6-3b397a245465",
                        "74632c0c-db08-47c2-b013-c70e5b67c49f"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesreviewer@fluidattacks.com')
    assert 'errors' not in result
    assert 'success' in result['data']['rejectZeroRiskVuln']
    assert result['data']['rejectZeroRiskVuln']['success']

    comments = await comment_dal.get_comments('zero_risk', 463558592)
    assert len(comments) == 1
    assert comments[0]['content'] == 'reject zero risk vuln'
    assert comments[0]['created'] == '2019-11-30 19:00:00'
    assert comments[0]['email'] == 'integratesreviewer@fluidattacks.com'
    assert comments[0]['finding_id'] == 463558592
    assert comments[0]['fullname'] == 'unit test'
    assert comments[0]['modified'] == '2019-11-30 19:00:00'
    comment_id = comments[0]['user_id']

    vulnerability = await vuln_domain.get_by_finding('463558592', '3bcdb384-5547-4170-a0b6-3b397a245465')
    assert len(vulnerability['historic_zero_risk']) == 2
    assert vulnerability['historic_zero_risk'][-1].get('comment_id') == comment_id
    assert vulnerability['historic_zero_risk'][-1].get('date') == '2019-11-30 19:00:00'
    assert vulnerability['historic_zero_risk'][-1].get('email') == 'integratesreviewer@fluidattacks.com'
    assert vulnerability['historic_zero_risk'][-1].get('status') == 'REJECTED'
    vulnerability = await vuln_domain.get_by_finding('463558592', '74632c0c-db08-47c2-b013-c70e5b67c49f')
    assert len(vulnerability['historic_zero_risk']) == 2
    assert vulnerability['historic_zero_risk'][-1].get('comment_id') == comment_id
    assert vulnerability['historic_zero_risk'][-1].get('date') == '2019-11-30 19:00:00'
    assert vulnerability['historic_zero_risk'][-1].get('email') == 'integratesreviewer@fluidattacks.com'
    assert vulnerability['historic_zero_risk'][-1].get('status') == 'REJECTED'


@pytest.mark.changes_db
async def test_reject_zero_risk_vuln_error_not_requested():
    """Check for not requested zero risk vuln with rejectZeroRiskVuln mutation."""
    query = '''
        mutation {
            rejectZeroRiskVuln(
                findingId: "463558592",
                justification: "reject zero risk vuln",
                vulnerabilities:
                    ["3bcdb384-5547-4170-a0b6-3b397a245465",
                        "74632c0c-db08-47c2-b013-c70e5b67c49f"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data)
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Exception - Zero risk vulnerability is not requested'

    vulnerability = await vuln_domain.get_by_finding('463558592', '3bcdb384-5547-4170-a0b6-3b397a245465')
    assert len(vulnerability['historic_zero_risk']) == 2
    vulnerability = await vuln_domain.get_by_finding('463558592', '74632c0c-db08-47c2-b013-c70e5b67c49f')
    assert len(vulnerability['historic_zero_risk']) == 2

    comments = await comment_dal.get_comments('zero_risk', 463558592)
    assert len(comments) == 1


@pytest.mark.changes_db
async def test_reject_zero_risk_vuln_error_vuln_not_in_finding():
    """Check for vuln not in finding with rejectZeroRiskVuln mutation."""
    query = '''
        mutation {
            rejectZeroRiskVuln(
                findingId: "463558592",
                justification: "reject zero risk vuln",
                vulnerabilities:
                    ["3bcdb384-5547-4170-a0b6-3b397a245465",
                        "81db1fad-c329-4356-a5eb-9ad9b0d75a7e"]
            ) {
                success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesreviewer@fluidattacks.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == str(VulnNotInFinding())

    vulnerability = await vuln_domain.get_by_finding('463558592', '3bcdb384-5547-4170-a0b6-3b397a245465')
    assert len(vulnerability['historic_zero_risk']) == 2
    vulnerability = await vuln_domain.get_by_finding('463558592', '74632c0c-db08-47c2-b013-c70e5b67c49f')
    assert len(vulnerability['historic_zero_risk']) == 2

    comments = await comment_dal.get_comments('zero_risk', 463558592)
    assert len(comments) == 1


async def test_reject_zero_risk_vuln_error_invalid_justification_lentgh():
    """Check for invalid justification lentgh with rejectZeroRiskVuln mutation."""
    justification = 'x' * 2001
    query = f'''
        mutation {{
            rejectZeroRiskVuln(
                findingId: "436992569",
                justification: "{justification}",
                vulnerabilities:
                    ["5afb9a49-a359-48ce-80ee-79c145919275",
                        "5ed5c3c0-9064-41f5-8ef2-5e1eeee62952"]
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesreviewer@fluidattacks.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == 'Exception - Justification must have a maximum of 2000 characters'


@pytest.mark.changes_db
async def test_remove_vulnerability():
    """Check for deleteVulnerability mutation."""
    query = '''
        mutation{
            deleteVulnerability (
            id: "a8c0ff07-bb21-4cd5-bb9f-4d716fc69320"
            findingId: "475041513"
            justification: REPORTING_ERROR
            ) {
            success
            }
        }
    '''
    data = {'query': query}
    result = await _get_result_async(data)
    assert 'errors' not in result
    assert 'success' in result['data']['deleteVulnerability']
    with pytest.raises(VulnNotFound):
        assert await vuln_domain.get_by_finding(
            '475041513', 'a8c0ff07-bb21-4cd5-bb9f-4d716fc69320')


@pytest.mark.changes_db
async def test_upload_file():
    """Check for uploadFile mutation."""
    filename = os.path.dirname(os.path.abspath(__file__))
    filename = os.path.join(filename, '../mock/test-vulns.yaml')
    vuln = await vuln_domain.get('74632c0c-db08-47c2-b013-c70e5b67c49f')
    assert vuln['historic_verification'][-1].get('status') == 'REQUESTED'

    with open(filename, 'rb') as test_file:
        uploaded_file = UploadFile(
            filename=test_file.name,
            file=test_file,
            content_type='text/x-yaml'
        )
        query = '''
            mutation UploadFileMutation(
                $file: Upload!, $findingId: String!
            ) {
                uploadFile (
                    file: $file,
                    findingId: $findingId
                ) {
                    success
                }
            }
        '''
        variables = {
            'file': uploaded_file,
            'findingId': '463558592',
        }
        data = {'query': query, 'variables': variables}
        result = await _get_result_async(data)

    assert 'errors' not in result
    assert 'success' in result['data']['uploadFile']
    vuln = await vuln_domain.get('74632c0c-db08-47c2-b013-c70e5b67c49f')
    finding = await finding_dal.get_attributes(
        '463558592', ['historic_verification']
    )
    assert vuln['historic_verification'][-1].get('status') == 'VERIFIED'
    assert len(finding['historic_verification'][-1].get('vulns')) == 2

    query = '''
        query GetFindingVulnInfo($findingId: String!) {
            finding(identifier: $findingId) {
                vulnerabilities {
                    commitHash
                    stream
                    specific
                    where
                }
            }
        }
    '''
    data = {'query': query, 'variables': {'findingId': '463558592'}}
    result = await _get_result_async(data)
    assert 'errors' not in result
    vulnerabilities = result['data']['finding']['vulnerabilities']
    for vuln in vulnerabilities:
        if (vuln['where'] == 'https://example.com'
                and vuln['specific'] == 'phone'):
            assert vuln['stream'] == 'home > blog > articulo'
        if (vuln['where'] == 'path/to/file3.ext'
                and vuln['specific'] == '345'):
            assert vuln['commitHash'] == 'e17059d1'


async def test_upload_file_error():
    filename = os.path.dirname(os.path.abspath(__file__))
    filename = os.path.join(filename, '../mock/test-vuln-error.yaml')

    with open(filename, 'rb') as test_file:
        uploaded_file = UploadFile(
            filename=test_file.name,
            file=test_file,
            content_type='text/x-yaml'
        )
        query = '''
            mutation UploadFileMutation($file: Upload!, $findingId: String!) {
                uploadFile (file: $file, findingId: $findingId) {
                    success
                }
            }
        '''
        variables = {
            'file': uploaded_file,
            'findingId': '463558592',
        }
        data = {'query': query, 'variables': variables}
        result = await _get_result_async(data)

    assert 'errors' in result
    assert str(InvalidSchema())[:-1] in result['errors'][0]['message']


async def test_upload_file_error_commit_hash():
    filename = os.path.dirname(os.path.abspath(__file__))
    filename = os.path.join(filename, '../mock/test-vuln-commit-hash-error.yaml')

    with open(filename, 'rb') as test_file:
        uploaded_file = UploadFile(
            filename=test_file.name,
            file=test_file,
            content_type='text/x-yaml'
        )
        query = '''
            mutation UploadFileMutation($file: Upload!, $findingId: String!) {
                uploadFile (file: $file, findingId: $findingId) {
                    success
                }
            }
        '''
        variables = {
            'file': uploaded_file,
            'findingId': '463558592',
        }
        data = {'query': query, 'variables': variables}
        result = await _get_result_async(data)

    assert 'errors' in result
    assert str(InvalidSchema())[:-1] in result['errors'][0]['message']


async def test_download_vuln_file():
    """Check for downloadVulnFile mutation."""
    query = '''
        mutation DownloadVulnFile($findingId: String!) {
            downloadVulnFile (findingId: $findingId) {
                url
                success
            }
        }
    '''
    finding_id = '463461507'
    project_name = 'unittesting'
    variables = {
        'findingId': finding_id,
    }
    data = {'query': query, 'variables': variables}
    result = await _get_result_async(data)
    assert 'errors' not in result
    assert 'success' in result['data']['downloadVulnFile']
    assert 'url' in result['data']['downloadVulnFile']
    assert f'd22vuezekkq177.cloudfront.net/{project_name}-{finding_id}' \
        in result['data']['downloadVulnFile']['url']


async def test_handle_acceptation_not_requested():
    query = f'''
        mutation {{
            handleVulnsAcceptation(
                findingId: "436992569"
                justification: "handle acceptation"
                acceptedVulns: ["5afb9a49-a359-48ce-80ee-79c145919275"]
                rejectedVulns: ["5ed5c3c0-9064-41f5-8ef2-5e1eeee62955"]
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == str(AcceptionNotRequested())


async def test_handle_acceptation_vuln_not_found():
    query = f'''
        mutation {{
            handleVulnsAcceptation(
                findingId: "560175507"
                justification: "handle acceptation"
                acceptedVulns: ["6f023c26-5x10-4ded-aa27-xx563c2206ax"]
                rejectedVulns: []
            ) {{
                success
            }}
        }}
    '''
    data = {'query': query}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == str(VulnNotFound())


async def test_update_vulns_treatment_invalid_treatment_manager():
    query = '''
        mutation UpdateVulnsTreatment(
            $findingId: String!,
            $justification: String!, $treatmentManager: String,
            $treatment: UpdateClientDescriptionTreatment!,
            $vulnerabilityId: ID!
        ) {
            updateVulnsTreatment (
                findingId: $findingId
                justification: $justification
                treatment: $treatment
                treatmentManager: $treatmentManager
                vulnerabilityId: $vulnerabilityId
            ) {
                success
            }
        }
    '''
    variables = {
        'findingId': '436992569', 'treatment': 'IN_PROGRESS',
        'justification': 'Test in progress treatment',
        'treatmentManager': 'integratesexecutive@gmail.com',
        'vulnerabilityId': 'b16ed89e-668d-42d6-add1-73535bb0e083',
    }
    data = {'query': query, 'variables': variables}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    assert 'errors' in result
    assert result['errors'][0]['message'] == str(InvalidTreatmentManager())


@pytest.mark.changes_db
async def test_handle_acceptation():
    query = '''
        mutation UpdateVulnsTreatment(
            $findingId: String!, $justification: String!,
            $treatment: UpdateClientDescriptionTreatment!
            $treatmentManager: String,
            $acceptedVulnId: ID!
            $rejectedVulnId: ID!
        ) {
            accepted: updateVulnsTreatment (
                findingId: $findingId
                justification: $justification
                treatment: $treatment
                treatmentManager: $treatmentManager
                vulnerabilityId: $acceptedVulnId
            ) {
                success
            }
            rejected: updateVulnsTreatment (
                findingId: $findingId
                justification: $justification
                treatment: $treatment
                treatmentManager: $treatmentManager
                vulnerabilityId: $rejectedVulnId
            ) {
                success
            }
        }
    '''
    vuln_ids = ['b16ed89e-668d-42d6-add1-73535bb0e083', 'd212a841-7d48-4cb6-b776-cccc2845c383']
    treatment_manager = 'integratesuser@gmail.com'
    variables = {
        'findingId': '436992569', 'treatment': 'ACCEPTED_UNDEFINED',
        'justification': 'Test to consider eternally accepted treatment',
        'treatmentManager': treatment_manager,
        'acceptedVulnId': vuln_ids[0],
        'rejectedVulnId': vuln_ids[1],
    }
    data = {'query': query, 'variables': variables}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    vulns = await vuln_domain.get_by_finding_and_uuids('436992569', set(vuln_ids))
    assert 'errors' not in result
    assert result['data']['accepted']['success']
    assert result['data']['rejected']['success']
    assert vulns[0]['historic_treatment'][-1]['treatment_manager'] == treatment_manager
    assert vulns[0]['historic_treatment'][-1]['treatment'] == 'ACCEPTED_UNDEFINED'
    assert vulns[0]['historic_treatment'][-1]['acceptance_status'] == 'SUBMITTED'
    query = '''
        mutation HandleVulnsAcceptationMutation(
            $findingId: String!
            $justification: String!
            $acceptedVulns: [String]!
            $rejectedVulns: [String]!
        ) {
            handleVulnsAcceptation(
                findingId: $findingId
                justification: $justification
                acceptedVulns: $acceptedVulns
                rejectedVulns: $rejectedVulns
            ) {
                success
            }
        }
    '''
    variables = {
        'findingId': '436992569',
        'justification': 'Test justification handle acceptation vulns',
        'acceptedVulns': [vuln_ids[0]],
        'rejectedVulns': [vuln_ids[1]],
    }
    data = {'query': query, 'variables': variables}
    result = await _get_result_async(data, user='integratesuser@gmail.com')
    vulns = await vuln_domain.get_by_finding_and_uuids('436992569', set(vuln_ids))
    assert 'errors' not in result
    assert 'success' in result['data']['handleVulnsAcceptation']
    assert result['data']['handleVulnsAcceptation']['success']
    assert vulns[0]['historic_treatment'][-1]['treatment_manager'] == treatment_manager
    assert vulns[0]['historic_treatment'][-1]['treatment'] == 'ACCEPTED_UNDEFINED'
    assert vulns[0]['historic_treatment'][-1]['acceptance_status'] == 'APPROVED'
    assert vulns[-1]['historic_treatment'][-1]['treatment'] != 'ACCEPTED_UNDEFINED'
    assert vulns[-1]['historic_treatment'][-2]['acceptance_status'] == 'REJECTED'
    assert await vuln_domain.send_treatment_change_mail(
        get_new_context(),
        '436992569',
        datetime_utils.get_now_minus_delta(days=1)
    )


async def test_vulnerability_verification():
    vuln1_id = '587c40de-09a0-4d85-a9f9-eaa46aa895d7'
    vuln2_id = '15375781-31f2-4953-ac77-f31134225747'
    expected_vuln1 = {
        'finding_id': '436992569',
        'UUID': vuln1_id,
        'vuln_type': 'ports',
        'specific': '1111',
        'where': '192.168.100.112',
        'cycles': 1,
        'last_requested_reattack_date': '2020-02-19 10:41:04',
        'efficacy': 0,
        'report_date': '2019-09-13 17:00:56',
        'last_reattack_date': '',
        'last_reattack_requester': 'integratesuser@gmail.com',
    }
    expected_vuln2 = {
        'finding_id': '436992569',
        'UUID': vuln2_id,
        'vuln_type': 'ports',
        'specific': '333',
        'where': '192.168.100.101',
        'cycles': 1,
        'last_requested_reattack_date': '2020-02-18 10:41:04',
        'efficacy': 0,
        'report_date': '2019-09-13 08:17:41',
        'last_reattack_date': '2020-02-19 10:41:04',
        'last_reattack_requester': 'integratesuser@gmail.com',
    }
    query = '''
        query GetVulnInfo($vuln1Id: String!, $vuln2Id: String!) {
            vuln1: vulnerability(uuid: $vuln1Id) {
                ...VulnInfo
            }
            vuln2: vulnerability(uuid: $vuln2Id) {
                ...VulnInfo
            }
        }
        fragment VulnInfo on Vulnerability {
            findingId
            id
            vulnType
            specific
            where
            cycles
            lastRequestedReattackDate
            efficacy
            reportDate
            lastReattackDate
            lastReattackRequester
        }
    '''
    variables = {'vuln1Id': vuln1_id, 'vuln2Id': vuln2_id}
    data = {'query': query, 'variables': variables}
    result = await _get_result_async(data)
    assert 'errors' not in result

    assert result['data']['vuln1']['findingId'] == expected_vuln1['finding_id']
    assert result['data']['vuln1']['where'] == expected_vuln1['where']
    assert result['data']['vuln1']['id'] == expected_vuln1['UUID']
    assert result['data']['vuln1']['specific'] == expected_vuln1['specific']
    assert result['data']['vuln1']['vulnType'] == expected_vuln1['vuln_type']
    assert result['data']['vuln1']['lastRequestedReattackDate'] == expected_vuln1.get(
        'last_requested_reattack_date'
    )
    assert result['data']['vuln1']['lastReattackRequester'] == expected_vuln1.get(
        'last_reattack_requester'
    )
    assert result['data']['vuln1']['cycles'] == expected_vuln1['cycles']
    assert result['data']['vuln1']['efficacy'] == expected_vuln1['efficacy']
    assert result['data']['vuln1']['reportDate'] == expected_vuln1['report_date']
    assert result['data']['vuln1']['lastReattackDate'] == expected_vuln1['last_reattack_date']

    assert result['data']['vuln2']['findingId'] == expected_vuln2['finding_id']
    assert result['data']['vuln2']['where'] == expected_vuln2['where']
    assert result['data']['vuln2']['id'] == expected_vuln2['UUID']
    assert result['data']['vuln2']['specific'] == expected_vuln2['specific']
    assert result['data']['vuln2']['vulnType'] == expected_vuln2['vuln_type']
    assert result['data']['vuln2']['lastRequestedReattackDate'] == expected_vuln2.get(
        'last_requested_reattack_date'
    )
    assert result['data']['vuln2']['lastReattackRequester'] == expected_vuln2.get(
        'last_reattack_requester'
    )
    assert result['data']['vuln2']['cycles'] == expected_vuln2['cycles']
    assert result['data']['vuln2']['efficacy'] == expected_vuln2['efficacy']
    assert result['data']['vuln2']['reportDate'] == expected_vuln2['report_date']
    assert result['data']['vuln2']['lastReattackDate'] == expected_vuln2['last_reattack_date']
