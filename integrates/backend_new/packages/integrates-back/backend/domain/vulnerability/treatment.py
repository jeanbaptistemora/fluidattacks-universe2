# Standard library
from typing import (
    Awaitable,
    Dict,
    List,
    cast,
)

# Third party
from aioextensions import collect

# Local
from backend import (
    authz,
    util,
)
from backend.dal import vulnerability as vuln_dal
from backend.typing import (
    Finding,
    Historic,
)
from backend.exceptions import VulnNotFound
from backend.utils import (
    datetime as datetime_utils,
    findings as finding_utils,
    validations,
)
from .vulnerability import (
    get_by_ids,
)
from .utils import (
    compare_historic_treatments,
    validate_acceptation,
    validate_treatment_manager,
    validate_vulns_in_finding,
)


async def add_vuln_treatment(
    *,
    finding_id: str,
    updated_values: Dict[str, str],
    vuln: Dict[str, Finding],
    user_email: str,
    date: str,
) -> bool:
    updated_values = util.update_treatment_values(updated_values)
    new_treatment = updated_values['treatment']
    new_state = {
        'date': date,
        'treatment': new_treatment,
    }

    if user_email:
        new_state['user'] = user_email
    if 'treatment_manager' in updated_values:
        new_state['treatment_manager'] = updated_values['treatment_manager']
    if new_treatment != 'NEW':
        validations.validate_fields([updated_values['justification']])
        validations.validate_field_length(updated_values['justification'], 200)
        new_state['justification'] = updated_values['justification']

    if new_treatment == 'ACCEPTED':
        new_state['acceptance_date'] = updated_values['acceptance_date']
    elif new_treatment == 'ACCEPTED_UNDEFINED':
        new_state['acceptance_status'] = updated_values['acceptance_status']

    historic_treatment = cast(
        List[Dict[str, str]],
        vuln.get('historic_treatment', [])
    )
    historic_treatment.append(new_state)

    return await vuln_dal.update(
        finding_id,
        str(vuln.get('UUID', '')),
        {'historic_treatment': historic_treatment}
    )


def is_vulnerabilities_treatment_changed(
    *,
    updated_values: Dict[str, str],
    vulnerabilities: List[Dict[str, Finding]],
) -> List[Dict[str, Finding]]:
    return [
        vuln for vuln in vulnerabilities
        if compare_historic_treatments(
            cast(Historic, vuln.get('historic_treatment', [{}]))[-1],
            updated_values,
        )
    ]


async def update_vulns_treatment(
    *,
    finding_id: str,
    updated_values: Dict[str, str],
    organization_name: str,
    finding_severity: float,
    user_email: str,
    vuln_ids: List[str],
    group_name: str,
) -> bool:
    success: bool = False
    vulnerabilities = await get_by_ids(vuln_ids)
    validate_vulns_in_finding(finding_id, vulnerabilities)
    today = datetime_utils.get_as_str(datetime_utils.get_now())
    if 'treatment_manager' in updated_values:
        role: str = await authz.get_group_level_role(user_email, group_name)
        updated_values['treatment_manager'] = await validate_treatment_manager(
            treatment_manager=updated_values['treatment_manager'],
            is_customer_admin=role in {'customeradmin', 'group_manager'},
            user_email=user_email,
            group_name=group_name,
        )
    treatment_vuls = is_vulnerabilities_treatment_changed(
        updated_values=updated_values,
        vulnerabilities=vulnerabilities
    )

    validations.validate_fields(list(updated_values.values()))
    are_changes_valid = await collect(
        finding_utils.validate_treatment_change(
            {
                'severity': finding_severity,
                'historic_treatment': cast(
                    List[Dict[str, str]],
                    vuln.get('historic_treatment', [])
                )
            },
            organization_name,
            updated_values
        )
        for vuln in treatment_vuls
    )
    success = all(await collect(
        add_vuln_treatment(
            finding_id=finding_id,
            updated_values=updated_values,
            vuln=vuln,
            user_email=user_email,
            date=today,
        )
        for vuln, is_change_valid in zip(treatment_vuls, are_changes_valid)
        if is_change_valid
    ))

    return success


async def handle_vulns_acceptation(
    *,
    accepted_vulns: List[str],
    finding_id: str,
    justification: str,
    rejected_vulns: List[str],
    user_email: str,
) -> bool:
    validations.validate_field_length(justification, 200)
    validations.validate_fields([justification])
    vuln_ids: List[str] = accepted_vulns + rejected_vulns
    today = datetime_utils.get_as_str(datetime_utils.get_now())
    coroutines: List[Awaitable[bool]] = []

    vulnerabilities = await get_by_ids(vuln_ids)
    validate_vulns_in_finding(finding_id, vulnerabilities)
    vulnerabilities = [validate_acceptation(vuln) for vuln in vulnerabilities]

    if not vulnerabilities:
        raise VulnNotFound()

    new_treatment = {
        'treatment': 'ACCEPTED_UNDEFINED',
        'justification': justification,
        'user': user_email,
        'date': today
    }
    if rejected_vulns:
        treatments = [
            {**new_treatment, 'acceptance_status': 'REJECTED'},
            {'treatment': 'NEW', 'date': today, 'user': user_email},
        ]
        coroutines.extend([
            handle_vuln_acceptation(
                finding_id=finding_id,
                new_treatments=treatments,
                vuln=vuln,
            )
            for vuln, vuln_id in zip(vulnerabilities, vuln_ids)
            if vuln_id in rejected_vulns
        ])
    if accepted_vulns:
        treatments = [{**new_treatment, 'acceptance_status': 'APPROVED'}]
        coroutines.extend([
            handle_vuln_acceptation(
                finding_id=finding_id,
                new_treatments=treatments,
                vuln=vuln,
            )
            for vuln, vuln_id in zip(vulnerabilities, vuln_ids)
            if vuln_id in accepted_vulns
        ])

    return all(await collect(coroutines))


async def handle_vuln_acceptation(
    *,
    finding_id: str,
    new_treatments: Historic,
    vuln: Dict[str, Finding],
) -> bool:
    historic_treatment = cast(
        Historic,
        vuln.get('historic_treatment', [])
    )
    if (historic_treatment
            and new_treatments[-1].get('acceptance_status') == 'APPROVED'):
        if 'treatment_manager' in historic_treatment[-1]:
            new_treatments[-1]['treatment_manager'] = (
                historic_treatment[-1]['treatment_manager']
            )

    historic_treatment.extend(new_treatments)

    return await vuln_dal.update(
        finding_id,
        str(vuln.get('UUID', '')),
        {'historic_treatment': historic_treatment}
    )
