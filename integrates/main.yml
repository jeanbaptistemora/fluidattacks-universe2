---
- hosts: integrates

  become: yes

  tasks:
   - name: include default step variables
     include_vars: ansible/templates/vars.yml

   - name: Instalar paquetes necesarios
     apt:
       pkg: "{{ item }}"
       state: installed
     register: dependencias
     with_items:
       - git
       - python-pip
       - apache2
       - libapache2-mod-wsgi

   - name: Instalar dependencias pip
     pip:
       name: "{{ item }}"
     with_items:
       - django
       - jinja2
       - pyyaml
       - openpyxl

   - name: Crear directorio para clonar repositorio
     file: 
       path: "/root/integrates/"
       state: directory

   - name: Agregar netrc
     template: 
       src: "ansible/templates/netrc.j2" 
       dest: "/root/.netrc" 
       mode: "0600"

   - name: Clonar repositorio integrates
     git:
       repo: "https://jrestrepoatfluid@bitbucket.org/fluidsignal/fluid-integrates.git"
       dest: "/root/integrates"
       version: "master"

   - name: Retirar git conf
     file:
       path: "/root/.netrc" 
       state: absent

#   - name: Crear directorio para logs
#     file:
#       path: "/root/logs" 
#       state: directory

#   - name: Crear error log
#     file:
#       path: "/root/logs/error.err" 
#       state: touch

#   - name: Crear error log
#     file:
#       path: "/root/logs/integrates.log"
#       state: touch

#   - name: Agregar script de inicio
#     template:
#       src: "ansible/templates/init.sh"
#       dest: "/root/init.sh"
#       mode: "0755"

#   - name: Correr servidor
#     command: /root/init.sh

