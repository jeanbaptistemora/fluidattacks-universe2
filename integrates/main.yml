---
- hosts: integrates

  become: yes

  tasks:
   - name: include default step variables
     include_vars: vars/vars.yml

   - name: Instalar paquetes necesarios
     apt:
       pkg: "{{ item }}"
       state: installed
     register: dependencias
     with_items:
       - git
       - python-pip
       - apache2
       - libapache2-mod-wsgi
       - python-setuptools

   - name: Instalar dependencias pip
     pip:
       name: "{{ item }}"
     with_items:
       - django
       - jinja2
       - pyyaml
       - openpyxl

   - name: Crear directorio para clonar repositorio
     file:
       path: "/root/integrates/"
       state: directory

   - name: Agregar netrc
     template:
       src: "vars/netrc.j2"
       dest: "/root/.netrc"
       mode: "0600"

   - name: Remover archivo index
     file:
       path: "/var/www/index.html"
       state: absent

   - name: Clonar repositorio integrates
     git:
       repo: "https://jrestrepoatfluid@bitbucket.org/fluidsignal/fluid-integrates.git"
       dest: "/var/www/integrates"
       version: "master"

   - name: Retirar git conf
     file:
       path: "/root/.netrc"
       state: absent

   - name: Creando sitio web
     template:
      src: "vars/default.j2"
      dest: "/etc/apache2/sites-available/000-default.conf"
      mode: "0644"
     notify:
       - reiniciar apache2

  handlers:
   - name: reiniciar apache2
     service:
       name: "apache2"
       state: "restarted"

