// SPDX-FileCopyrightText: 2022 Fluid Attacks <development@fluidattacks.com>
//
// SPDX-License-Identifier: MPL-2.0

digraph architecture {
  label="Fluid Attacks Architecture"
  // If things overlap you can play with the following options:
  // layout="fdp"
  layout="dot"
  // scale="scale"
  scale="scalexy"
  // splines="ortho"
  // edge[len=6 minlen=4]
  // margin=12

  customer[label="Customer"]

  subgraph cluster_gitlab {
    label="GitLab";

    subgraph cluster_gitlab_airs {
      label="Airs";

      gitlab_airs[label="Source Code"];
      gitlab_airs_gatsby[label="Gatsby"]
      gitlab_airs_typescript[label="TypeScript"]
      gitlab_airs_tachyons[label="Tachyons"]
      gitlab_airs_react[label="React"]
    }
  }

  subgraph cluster_aws {
    label="AWS"

    subgraph cluster_aws_s3 {
      label="S3"
      aws_s3_airs_dev[label="web.eph.fluidattacks.com"];
      aws_s3_airs_prod[label="fluidattacks.com"];
      aws_s3_airs_prod_static[label="Static Content"];
    }
  }

  subgraph cluster_cloudinary {
    label="Cloudinary"

    subgraph cluster_cloudinary_media {
      label="Media"

      cloudinary_media_airs[label="airs"]
      cloudinary_media_blog[label="blog"]
      cloudinary_media_docs[label="docs"]
      cloudinary_media_notifications[label="notifications"]
    }
  }

  subgraph cluster_algolia {
    label="Algolia"

    subgraph cluster_algolia_index {
      label="Index"

      algolia_airs[label="fluidattacks_airs"]
    }
  }

  subgraph cluster_cloudflare {
    label="Cloudflare"
    subgraph cluster_cloudflare_domain {
      label="Domains"
      cloudflare_domain_prod[label="fluidattacks.com"]
    }
  }

  {
    // Global
    customer -> cloudflare_domain_prod[label="uses"]
  }

  {
    // Airs
    aws_s3_airs_prod -> aws_s3_airs_prod_static[label="has" dir="back" arrowtail="odiamond"]
    aws_s3_airs_prod_static -> algolia_airs[label="uses"]
    aws_s3_airs_prod_static -> cloudinary_media_blog[label="uses"]
    aws_s3_airs_prod_static -> cloudinary_media_airs[label="uses"]
    cloudflare_domain_prod -> aws_s3_airs_prod[label="uses"]
    gitlab_airs -> aws_s3_airs_prod[label="deployed to"]
    gitlab_airs -> gitlab_airs_gatsby[label="uses"]
    gitlab_airs -> gitlab_airs_typescript[label="uses"]
    gitlab_airs -> gitlab_airs_tachyons[label="uses"]
    gitlab_airs -> gitlab_airs_react[label="uses"]
  }
}
