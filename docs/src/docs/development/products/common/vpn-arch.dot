// SPDX-FileCopyrightText: 2022 Fluid Attacks <development@fluidattacks.com>
//
// SPDX-License-Identifier: MPL-2.0

digraph common {
  label="Common's /vpn Architecture"
  labelloc="t"
  compound="true"
  // concentrate="true"
  rankdir="LR"
  scale="scalexy"
  splines="line"

  node[style="filled"]
  graph[style="dashed,rounded"]

  subgraph cluster_aws {
    label="AWS"
    bgcolor="0.1 0.1 1.0"
    node[fillcolor="0.1 0.5 1.0"]

    subgraph cluster_aws_vpc {
      label="VPC"

      subgraph cluster_aws_vpc_fluid_vpc {
        label="fluid-vpc (192.168.0.0/16)"

        cluster_aws_vpc_fluid_vpc[label="" style="invis"]

        subgraph cluster_aws_route53_zones {
          label="Private Route53 Zones"

          subgraph cluster_aws_route53_zones_customer_1 {
            label="customer1.com"

            subgraph cluster_aws_route53_zones_customer_1_records {
              label="Records"

              aws_route53_zones_customer_1_records_A_1[label="subdomain1.customer1.com"]
              aws_route53_zones_customer_1_records_A_2[label="subdomain2.customer1.com"]
            }
          }

          subgraph cluster_aws_route53_zones_customer_2 {
            label="customer2.com"

            subgraph cluster_aws_route53_zones_customer_2_records {
              label="Records"

              aws_route53_zones_customer_2_records_A_1[label="subdomain1.customer2.com"]
              aws_route53_zones_customer_2_records_A_2[label="subdomain2.customer2.com"]
            }
          }
        }

        subgraph cluster_aws_vpc_fluid_vpc_cg {
          label="Customer Gateways"

          aws_vpc_fluid_vpc_cg1_main[label="metadata" style="dashed"]
          aws_vpc_fluid_vpc_cg2_main[label="metadata" style="dashed"]
        }

        subgraph cluster_aws_vpc_fluid_vpc_route_tables {
          label="Route Tables"

          subgraph cluster_aws_vpc_fluid_vpc_route_tables_main {
            label="main"

            aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_1[label="$customer_1_cdir_1"]
            aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_2[label="$customer_1_cdir_2"]
            aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_1[label="$customer_2_cdir_1"]
            aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_2[label="$customer_2_cdir_2"]
          }
        }

        subgraph cluster_aws_vpc_fluid_vpc_vpnc {
          label="Site-to-Site VPN Connections"

          subgraph cluster_aws_vpc_fluid_vpc_vpnc1 {
            label="Customer 1"

            cluster_aws_vpc_fluid_vpc_vpnc1[label="" style="invis"]

            subgraph cluster_aws_vpc_fluid_vpc_vpnc1_routes {
              label="Routes"

              aws_vpc_fluid_vpc_vpnc1_routes_1[label="$customer_1_cdir_1"]
              aws_vpc_fluid_vpc_vpnc1_routes_2[label="$customer_1_cdir_2"]
            }
          }

          subgraph cluster_aws_vpc_fluid_vpc_vpnc2 {
            label="Customer 2"

            cluster_aws_vpc_fluid_vpc_vpnc2[label="" style="invis"]

            subgraph cluster_aws_vpc_fluid_vpc_vpnc2_routes {
              label="Routes"

              aws_vpc_fluid_vpc_vpnc2_routes_1[label="$customer_2_cdir_1"]
              aws_vpc_fluid_vpc_vpnc2_routes_2[label="$customer_2_cdir_2"]
            }
          }
        }

        subgraph cluster_aws_vpc_fluid_vpc_vpg {
          label="Virtual Private Gateways"

          aws_vpc_fluid_vpc_vpg_main[label="main (ipsec.1)"]
        }
      }
    }
  }

  subgraph cluster_customer1_network {
    label="Customer1 Network"
    bgcolor="0.0 0.0 0.95"
    node[fillcolor="0.0 0.0 0.8"]

    customer1_network_gateway[label="Gateway Device (ipsec.1) (phisical)"]
  }

  subgraph cluster_customer2_network {
    label="Customer2 Network"
    bgcolor="0.0 0.0 0.95"
    node[fillcolor="0.0 0.0 0.8"]

    customer2_network_gateway[label="Gateway Device (ipsec.1) (phisical)"]
  }

  subgraph cluster_gitlab {
    label="GitLab"
    bgcolor="0.8 0.1 1.0"
    node[fillcolor="0.8 0.5 1.0"]

    subgraph cluster_gitlab_git {
      label="Git"

      subgraph cluster_gitlab_git_common {
        label="/common"

        subgraph cluster_gitlab_git_common_vpn {
          label="/vpn"

          cluster_gitlab_git_common_vpn[label="" style="invis"]
          gitlab_git_common_vpn[label="Source Code"]
          gitlab_git_common_vpn_sops[label="SOPS YAML (encrypted customer data)"]
          gitlab_git_common_vpn_terraform[label="Terraform"]
        }
      }
    }
  }

  edge[color="0.1 1.0 1.0"]
  aws_route53_zones_customer_1_records_A_1 -> aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_1[label="A"]
  aws_route53_zones_customer_1_records_A_2 -> aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_2[label="A"]
  aws_route53_zones_customer_2_records_A_1 -> aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_1[label="A"]
  aws_route53_zones_customer_2_records_A_2 -> aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_2[label="A"]
  aws_vpc_fluid_vpc_cg1_main -> customer1_network_gateway[style="dashed"]
  aws_vpc_fluid_vpc_cg2_main -> customer2_network_gateway[style="dashed"]
  aws_vpc_fluid_vpc_vpg_main -> cluster_aws_vpc_fluid_vpc_vpnc1[lhead="cluster_aws_vpc_fluid_vpc_vpnc1"]
  aws_vpc_fluid_vpc_vpg_main -> cluster_aws_vpc_fluid_vpc_vpnc2[lhead="cluster_aws_vpc_fluid_vpc_vpnc2"]
  aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_1 -> aws_vpc_fluid_vpc_vpg_main[]
  aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_2 -> aws_vpc_fluid_vpc_vpg_main[]
  aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_1 -> aws_vpc_fluid_vpc_vpg_main[]
  aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_2 -> aws_vpc_fluid_vpc_vpg_main[]
  aws_vpc_fluid_vpc_vpnc1_routes_1 -> aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_1[label="Propagates Route" style="dashed" constraint="false"]
  aws_vpc_fluid_vpc_vpnc1_routes_2 -> aws_vpc_fluid_vpc_route_tables_main_customer_1_cidr_2[label="Propagates Route" style="dashed" constraint="false"]
  aws_vpc_fluid_vpc_vpnc2_routes_1 -> aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_1[label="Propagates Route" style="dashed" constraint="false"]
  aws_vpc_fluid_vpc_vpnc2_routes_2 -> aws_vpc_fluid_vpc_route_tables_main_customer_2_cidr_2[label="Propagates Route" style="dashed" constraint="false"]
  cluster_aws_vpc_fluid_vpc_vpnc1 -> aws_vpc_fluid_vpc_cg1_main[ltail="cluster_aws_vpc_fluid_vpc_vpnc1"]
  cluster_aws_vpc_fluid_vpc_vpnc2 -> aws_vpc_fluid_vpc_cg2_main[ltail="cluster_aws_vpc_fluid_vpc_vpnc2"]


  edge[color="0.6 1.0 1.0"]

  edge[color="0.8 1.0 1.0"]
  gitlab_git_common_vpn -> gitlab_git_common_vpn_sops[]
  gitlab_git_common_vpn -> gitlab_git_common_vpn_terraform[]

  node[fillcolor="0.0 0.0 0.8"]
  developer[label="Developer"]
  end_user[label="End User"]

  edge[color="0.0 0.0 0.0"]
  end_user -> customer1_network_gateway
  end_user -> customer2_network_gateway
  developer -> cluster_aws_vpc_fluid_vpc[lhead="cluster_aws_vpc_fluid_vpc"]
  developer -> cluster_gitlab_git_common_vpn[lhead="cluster_gitlab_git_common_vpn"]
}
