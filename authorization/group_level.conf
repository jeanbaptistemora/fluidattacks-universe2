[request_definition]
r = subject, object, action

[policy_definition]
p = level, subject, object, role

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m =  (r.subject == p.subject) \
  && (  (p.level == 'user' && p.role == 'admin') \
     || (p.level == 'group' && r.object == p.object)) \
  && ( \
    (regexMatch(p.role, '^(admin|analyst|customer|customeradmin)$') \
    && (r.action == 'backend_api_query_Query_resolve_resources' \
     || r.action == 'backend_api_query_Query_resolve_alert' \
     || r.action == 'backend_api_query_Query_resolve_forces_executions' \
     || r.action == 'backend_api_query_Query_resolve_project' \
     || r.action == 'backend_api_query_Query_resolve_finding' \
     || r.action == 'backend_api_query_Query_resolve_event' \
     || r.action == 'backend_entity_event_AddEventComment_mutate' \
     || r.action == 'backend_entity_event_DownloadEventFile_mutate' \
     || r.action == 'backend_entity_resource_DownloadFile_mutate' \
     || r.action == 'backend_entity_finding_AddFindingComment_mutate' \
     || r.action == 'backend_entity_project_Project_resolve_comments' \
     || r.action == 'backend_entity_project_Project_resolve_events' \
     || r.action == 'backend_entity_project_AddProjectComment_mutate' \
     || r.action == 'backend_entity_vulnerability_RequestVerificationVuln_mutate')) \
 || (regexMatch(p.role, '^(admin|analyst)$') \
    && (r.action == 'backend_entity_vulnerability_DeleteVulnerability_mutate' \
     || r.action == 'backend_entity_vulnerability_UploadFile_mutate' \
     || r.action == 'backend_entity_vulnerability_ApproveVulnerability_mutate' \
     || r.action == 'backend_entity_vulnerability_Vulnerability_resolve_last_analyst' \
     || r.action == 'backend_entity_vulnerability_Vulnerability_resolve_analyst' \
     || r.action == 'backend_entity_event_CreateEvent_mutate' \
     || r.action == 'backend_entity_event_SolveEvent_mutate' \
     || r.action == 'backend_entity_event_UpdateEventEvidence_mutate' \
     || r.action == 'backend_entity_event_RemoveEventEvidence_mutate' \
     || r.action == 'backend_entity_finding_Finding_resolve_historic_state' \
     || r.action == 'backend_entity_finding_Finding_resolve_observations' \
     || r.action == 'backend_entity_finding_Finding_resolve_analyst' \
     || r.action == 'backend_entity_finding_RemoveEvidence_mutate' \
     || r.action == 'backend_entity_finding_UpdateEvidence_mutate' \
     || r.action == 'backend_entity_finding_UpdateEvidenceDescription_mutate' \
     || r.action == 'backend_entity_finding_UpdateSeverity_mutate' \
     || r.action == 'backend_entity_finding_VerifyFinding_mutate' \
     || r.action == 'backend_entity_vulnerability_VerifyRequestVuln_mutate' \
     || r.action == 'backend_entity_finding_UpdateDescription_mutate' \
     || r.action == 'backend_entity_finding_RejectDraft_mutate' \
     || r.action == 'backend_entity_finding_DeleteFinding_mutate' \
     || r.action == 'backend_entity_finding_CreateDraft_mutate' \
     || r.action == 'backend_entity_finding_SubmitDraft_mutate' \
     || r.action == 'backend_entity_project_Project_resolve_drafts')) \
 || (regexMatch(p.role, '^(admin|customer|customeradmin)$') \
    && (r.action == 'backend_entity_resource_AddResources_mutate' \
     || r.action == 'backend_entity_resource_AddEnvironments_mutate' \
     || r.action == 'backend_entity_resource_AddRepositories_mutate' \
     || r.action == 'backend_entity_resource_UpdateResources_mutate' \
     || r.action == 'backend_entity_resource_UpdateEnvironment_mutate' \
     || r.action == 'backend_entity_resource_UpdateRepository_mutate' \
     || r.action == 'backend_entity_resource_AddFiles_mutate' \
     || r.action == 'backend_entity_resource_RemoveFiles_mutate' \
     || r.action == 'backend_entity_vulnerability_DeleteTags_mutate' \
     || r.action == 'backend_entity_vulnerability_UpdateTreatmentVuln_mutate' \
     || r.action == 'backend_entity_finding_UpdateClientDescription_mutate' \
     || r.action == 'backend_entity_project_RemoveTag_mutate' \
     || r.action == 'backend_entity_project_AddTags_mutate')) \
 || (regexMatch(p.role, '^(admin|customeradmin)$') \
    && (r.action == 'backend_api_query_Query_resolve_user' \
     || r.action == 'backend_entity_user_GrantUserAccess_mutate' \
     || r.action == 'backend_entity_user_RemoveUserAccess_mutate' \
     || r.action == 'backend_entity_user_EditUser_mutate' \
     || r.action == 'backend_entity_finding_HandleAcceptation_mutate' \
     || r.action == 'backend_entity_project_Project_resolve_users' \
     || r.action == 'backend_entity_project_RequestRemoveProject_mutate' \
     || r.action == 'backend_entity_project_RejectRemoveProject_mutate')) \
 || (regexMatch(p.role, '^(admin|customer|customeradmin)$') \
    && regexMatch(p.subject, '.*@fluidattacks.com$') \
    && (r.action == 'backend_api_query_Query_resolve_user_list_projects' \
     || r.action == 'backend_entity_alert_SetAlert_mutate' \
     || r.action == 'backend_entity_event_CreateEvent_mutate' \
     || r.action == 'backend_entity_user_User_resolve_list_projects')) \
 || (p.role == 'admin' \
    && (r.action == 'backend_api_query_Query_resolve_alive_projects' \
     || r.action == 'backend_api_query_Query_resolve_user_list_projects' \
     || r.action == 'backend_api_query_Query_resolve_user' \
     || r.action == 'backend_entity_finding_ApproveDraft_mutate' \
     || r.action == 'backend_entity_project_AddAllProjectAccess_mutate' \
     || r.action == 'backend_entity_project_RemoveAllProjectAccess_mutate'\
     || r.action == 'backend_entity_project_Project_resolve_users' \
     || r.action == 'backend_entity_project_RequestRemoveProject_mutate' \
     || r.action == 'backend_entity_project_RejectRemoveProject_mutate' \
     || r.action == 'backend_entity_alert_SetAlert_mutate' \
     || r.action == 'backend_entity_user_User_resolve_list_projects' \
     || r.action == 'backend_entity_user_GrantUserAccess_mutate' \
     || r.action == 'backend_entity_user_RemoveUserAccess_mutate' \
     || r.action == 'backend_entity_user_EditUser_mutate' \
     || r.action == 'backend_entity_finding_HandleAcceptation_mutate')) \
  )
