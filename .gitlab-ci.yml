stages:
  - build
  - analytics
  - terraform-backend
  - test
  - mr-check
  - deploy
  - eks-initial-setup
  - postdeploy
  - rotation

.only_schedules: &only_schedules
  only:
    refs:
      - schedules

.except_analytics: &except_analytics
  except:
    variables:
      - $FLAG_REFRESH_TOKENS
      - $FLAG_SYNC_CURRENCIES
      - $FLAG_SYNC_FORMSTACK
      - $FLAG_SYNC_AWSDYNAMODB
      - $FLAG_SYNC_TIMEDOCTOR
      - $FLAG_SYNC_GIT
      - $FLAG_SYNC_MANDRILL
      - $FLAG_SYNC_INFRASTRUCTURE
      - $FLAG_SYNC_SALESFORCE
      - $FLAG_SYNC_INTERCOM
      - $FLAG_SYNC_GITLAB
      - $FLAG_SYNC_CONTINUOUS
      - $FLAG_SYNC_ZOHO

build-builder:
  image: fluidattacks/docker-bash:latest
  tags: [autoscaling]
  stage: build
  script:
    - ./ci-scripts/jobs/build-builder.sh
  <<: *except_analytics

build-exams:
  image: fluidattacks/docker-bash:latest
  tags: [autoscaling]
  stage: build
  script:
    - ./ci-scripts/jobs/build-exams.sh
  <<: *except_analytics

build-vpn:
  image: fluidattacks/docker-bash:latest
  tags: [autoscaling]
  stage: build
  script:
    - ./ci-scripts/jobs/build-vpn.sh
  <<: *except_analytics

test_code:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - ./check-changed.sh
  except:
    - master

commitlint:
  image: starefossen/ruby-node:2-10
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  before_script:
    - npm install --unsafe-perm
  script:
    - ./ci-scripts/commitlint-checks.sh
  except:
    - master
    - schedules

test_terraform:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - ./infrastructure/terraform.sh
  after_script:
    - rm infrastructure/*.xml
  except:
    - master

danger:
  image: fluidattacks/danger-ruby
  tags: [autoscaling]
  stage: mr-check
  only:
    - merge_requests
  variables:
    DANGER_GITLAB_API_TOKEN: $DANGER_TOKEN
  before_script:
    - export CI_MERGE_REQUEST_ID=$(git ls-remote -q origin merge-requests\*\head
      | grep ${CI_COMMIT_SHA}
      | sed 's/.*refs\/merge-requests\/\([0-9]*\)\/head/\1/g')
    - npm install --unsafe-perm
  script:
    - danger --verbose --fail-on-errors=true

deploy_infra:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - sed -i 's/plan/apply\ -auto-approve/g' infrastructure/terraform.sh
    - ./infrastructure/terraform.sh deployment
  only:
    - master
  except:
    - schedules

new-version-mail:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: postdeploy
  script:
    - ./ci-scripts/jobs/new-version-mail.sh
  only:
    - master
  except:
    - schedules

fluidasserts_post:
  tags: [autoscaling]
  stage: postdeploy
  image: fluidattacks/asserts
  script:
    - asserts asserts/exploit.py
  only:
    - master
  except:
    - schedules

change-keys-integrates-jwt:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    ./ci-scripts/jobs/change-keys-integrates-jwt.sh
  <<: *only_schedules
  <<: *except_analytics
  when: always

change-keys-aws-integrates-prod:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    - . ci-scripts/jobs/user-provision-integrates-prod.sh
    - user_provision_integrates_prod_rotate_aws
  <<: *only_schedules
  <<: *except_analytics
  when: always

change-keys-aws-integrates-dev:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    - . ci-scripts/jobs/user-provision-integrates-dev.sh
    - user_provision_integrates_dev_rotate_aws
  <<: *only_schedules
  <<: *except_analytics
  when: always

change-keys-aws-continuous-dev:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    - . ci-scripts/jobs/user-provision-continuous-dev.sh
    - user_provision_continuous_dev_rotate_aws
  <<: *only_schedules
  <<: *except_analytics
  when: always

change-keys-aws-continuous-prod:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    - . ci-scripts/jobs/user-provision-continuous-prod.sh
    - user_provision_continuous_prod_rotate_aws
  <<: *only_schedules
  <<: *except_analytics
  when: always

change-keys-aws-web-prod:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    - . ci-scripts/jobs/user-provision-web-prod.sh
    - user_provision_web_prod_rotate_aws
  <<: *only_schedules
  <<: *except_analytics
  when: always

vault_backup:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: rotation
  script:
    - aws s3 cp
        s3://$FS_S3_BUCKET_NAME/terraform/kubeconfig
        $HOME/.kube/config
    - cd infrastructure/eks/manifests/vault/
    - kubectl apply -f backup-operator.yaml
    - kubectl rollout status deploy/vault-etcd-operator-etcd-backup-operator
    - envsubst < credentials > creds
        && mv creds credentials
    - envsubst < config > conf
        && mv conf config
    - kubectl create secret generic aws
        --from-file=credentials
        --from-file=config
    - export DATE=$(date +%Y-%m-%d)
    - envsubst < backup.yaml > backup
        && mv backup backup.yaml
    - kubectl apply -f backup.yaml
    - while ! aws s3 ls s3://$VAULT_S3_BUCKET | grep backup-$(date +%Y-%m-%d);
        do sleep 2;
      done
    - kubectl delete -f backup.yaml
    - kubectl delete secret aws
    - kubectl delete -f backup-operator.yaml
    - rm credentials
  <<: *only_schedules
  <<: *except_analytics

analytics-sync-formstack:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-formstack.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_FORMSTACK

analytics-sync-dynamodb:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling-large]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-dynamodb.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_AWSDYNAMODB

analytics-sync-timedoctor:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-timedoctor.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_TIMEDOCTOR

analytics-sync-git:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling-large]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-git.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_GIT

analytics-sync-mandrill:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-mandrill.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_MANDRILL

analytics-sync-infrastructure:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-infrastructure.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_INFRASTRUCTURE

analytics-sync-intercom:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-intercom.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_INTERCOM

analytics-sync-gitlab:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling-large]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-gitlab.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_GITLAB

analytics-sync-continuous:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-continuous.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_CONTINUOUS

analytics-refresh-token-timedoctor:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-refresh-token-timedoctor.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_REFRESH_TOKENS

analytics-sync-zoho:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: analytics
  script:
    - ./ci-scripts/jobs/analytics-sync-zoho.sh
  <<: *only_schedules
  only:
    variables:
      - $FLAG_SYNC_ZOHO

.eks-initial-setup:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: eks-initial-setup
  script:
    - . ci-scripts/jobs/eks.sh
    - eks_initial_setup
  only:
    - master
  except:
    - schedules

.eks-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/eks.sh
    - eks_terraform_apply
  only:
    - master
  except:
    - schedules

eks-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/eks.sh
    - eks_terraform_lint
  except:
    - schedules

eks-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/eks.sh
    - eks_terraform_plan
  except:
    - schedules

terraform-states-bucket:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: terraform-backend
  script:
    - ./ci-scripts/jobs/terraform-states-bucket.sh
  only:
    - master
  except:
    - schedules

sops-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/sops.sh
    - sops_terraform_lint
  except:
    - schedules

sops-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/sops.sh
    - sops_terraform_plan
  except:
    - schedules

sops-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/sops.sh
    - sops_terraform_apply
  only:
    - master
  except:
    - schedules

aws-sso-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/aws-sso.sh
    - aws_sso_terraform_lint
  except:
    - schedules

aws-sso-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/aws-sso.sh
    - aws_sso_terraform_plan
  except:
    - schedules

aws-sso-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/aws-sso.sh
    - aws_sso_terraform_apply
  only:
    - master
  except:
    - schedules

break-build-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/break-build.sh
    - break_build_terraform_apply
  only:
    - master
  except:
    - schedules

break-build-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/break-build.sh
    - break_build_terraform_lint
  except:
    - schedules

break-build-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/break-build.sh
    - break_build_terraform_plan
  except:
    - schedules

user-provision-integrates-prod-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-integrates-prod.sh
    - user_provision_integrates_prod_terraform_lint
  except:
    - schedules

user-provision-integrates-prod-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-integrates-prod.sh
    - user_provision_integrates_prod_terraform_plan
  except:
    - schedules

user-provision-integrates-prod-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/user-provision-integrates-prod.sh
    - user_provision_integrates_prod_terraform_apply
  only:
    - master
  except:
    - schedules

user-provision-integrates-dev-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-integrates-dev.sh
    - user_provision_integrates_dev_terraform_lint
  except:
    - schedules

user-provision-integrates-dev-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-integrates-dev.sh
    - user_provision_integrates_dev_terraform_plan
  except:
    - schedules

user-provision-integrates-dev-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/user-provision-integrates-dev.sh
    - user_provision_integrates_dev_terraform_apply
  only:
    - master
  except:
    - schedules

user-provision-continuous-dev-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-continuous-dev.sh
    - user_provision_continuous_dev_terraform_lint
  except:
    - schedules

user-provision-continuous-dev-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-continuous-dev.sh
    - user_provision_continuous_dev_terraform_plan
  except:
    - schedules

user-provision-continuous-dev-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/user-provision-continuous-dev.sh
    - user_provision_continuous_dev_terraform_apply
  only:
    - master
  except:
    - schedules

user-provision-continuous-prod-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-continuous-prod.sh
    - user_provision_continuous_prod_terraform_lint
  except:
    - schedules

user-provision-continuous-prod-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-continuous-prod.sh
    - user_provision_continuous_prod_terraform_plan
  except:
    - schedules

user-provision-continuous-prod-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/user-provision-continuous-prod.sh
    - user_provision_continuous_prod_terraform_apply
  only:
    - master
  except:
    - schedules

user-provision-web-prod-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-web-prod.sh
    - user_provision_web_prod_terraform_lint
  except:
    - schedules

user-provision-web-prod-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/user-provision-web-prod.sh
    - user_provision_web_prod_terraform_plan
  except:
    - schedules

user-provision-web-prod-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/user-provision-web-prod.sh
    - user_provision_webprod_prod_terraform_apply
  only:
    - master
  except:
    - schedules

autoscaling-ci-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/autoscaling-ci.sh
    - autoscaling_ci_terraform_lint
  except:
    - schedules

autoscaling-ci-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/autoscaling-ci.sh
    - autoscaling_ci_terraform_plan
  except:
    - schedules

autoscaling-ci-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/autoscaling-ci.sh
    - autoscaling_ci_terraform_apply
  only:
    - master
  except:
    - schedules

analytics-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/analytics.sh
    - analytics_terraform_lint
  except:
    - schedules

analytics-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/analytics.sh
    - analytics_terraform_plan
  except:
    - schedules

analytics-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/analytics.sh
    - analytics_terraform_apply
  only:
    - master
  except:
    - schedules

fluid-vpc-terraform-lint:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/fluid-vpc.sh
    - fluid_vpc_terraform_lint
  except:
    - schedules

fluid-vpc-terraform-plan:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: test
  needs: [build-builder]
  script:
    - . ci-scripts/jobs/fluid-vpc.sh
    - fluid_vpc_terraform_plan
  except:
    - schedules

fluid-vpc-terraform-apply:
  image: registry.gitlab.com/fluidattacks/serves/builder:$CI_COMMIT_REF_NAME
  tags: [autoscaling]
  stage: deploy
  script:
    - . ci-scripts/jobs/fluid-vpc.sh
    - fluid_vpc_terraform_apply
  only:
    - master
  except:
    - schedules

asserts-static:
  stage: test
  tags: [autoscaling]
  needs: [build-builder]
  image:
    name: fluidattacks/break-build
    entrypoint: [""]
  before_script:
    - docker pull fluidattacks/break-build
  script:
    - bash <(docker run fluidattacks/break-build
              --static
              --id ${BREAK_BUILD_ID}
              --secret ${BREAK_BUILD_SECRET}
              --gitlab-docker-socket-binding
             ) || true
  except:
    - master
  interruptible: true

asserts-dynamic:
  stage: postdeploy
  tags: [autoscaling]
  image:
    name: fluidattacks/break-build
    entrypoint: [""]
  before_script:
    - docker pull fluidattacks/break-build
  script:
    - bash <(docker run fluidattacks/break-build
              --dynamic
              --id ${BREAK_BUILD_ID}
              --secret ${BREAK_BUILD_SECRET}
              --gitlab-docker-socket-binding
             ) || true
  only:
    - master
  interruptible: true
