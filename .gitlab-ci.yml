include:
  - local: forces/.gitlab-ci.yml
  - local: integrates/.gitlab-ci.yml
  - local: reviews/.gitlab-ci.yml
  - local: skims/.gitlab-ci.yml

stages:
  - rotation
  - build
  - lint-code
  - test-code
  - test-infra
  - test-security
  - merge-request
  - deploy-infra
  - deploy-app
  - post-deploy
  - analytics
  - subscriptions
  - external
  - scheduler

.commit_stages:
  - &all_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|forces|integrates|reviews|skims)/'

.all_in_mrs: &all_in_mrs
  rules:
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true

.all_in_dev_and_master_branch: &all_in_dev_and_master_branch
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *all_commit_pattern

common_build_nix_caches:
  <<: *with_nix
  tags: [autoscaling-large]
  image: nixos/nix:2.3
  stage: build
  before_script:
    - apk add --no-cache bash
  parallel: 45
  interruptible: false
  only:
    refs: [schedules]
    variables: [$build_nix_caches]

common_lint_build_system:
  <<: *with_nix
  <<: *all_in_dev_and_master_branch
  stage: lint-code

common_lint_commit_msg:
  <<: *with_nix
  except:
    refs:
      - schedules
      - triggers
  stage: lint-code

reviews:
  <<: *with_nix
  stage: merge-request
  <<: *all_in_mrs
  interruptible: false
