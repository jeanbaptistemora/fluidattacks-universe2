---

image: "${CI_REGISTRY_IMAGE}:builder"

stages:
  - build
  - test
  - before-mr
  - at-mr
  - deploy
  - release_to_pypi
  - release_to_docker
  - notify

.in_dev_branch: &in_dev_branch
  except:
    refs:
      - master
      - triggers
      - schedules

.in_prod_branch: &in_prod_branch
  only:
    refs:
      - master
  except:
    refs:
      - triggers
      - schedules

.with_nix: &with_nix
  tags: [autoscaling]
  image: fluidattacks/nix
  script:
    - ./build.sh
  interruptible: true

.test_template: &test_template
  <<: *with_nix
  <<: *in_dev_branch
  before_script:
    - ./build/scripts/odbc/set.sh
  stage: test

build_fluidasserts_release:
  <<: *with_nix
  <<: *in_dev_branch
  artifacts:
    paths: [result.build_fluidasserts_release/]
  stage: test

demo_fluidasserts_output:
  <<: *with_nix
  <<: *in_dev_branch
  stage: test

lint_fluidasserts_code:
  <<: *with_nix
  <<: *in_dev_branch
  stage: test

lint_fluidasserts_test_code:
  <<: *with_nix
  <<: *in_dev_branch
  stage: test

lint_nix_code:
  <<: *with_nix
  <<: *in_dev_branch
  stage: test

lint_shell_code:
  <<: *with_nix
  <<: *in_dev_branch
  stage: test

lint_with_bandit:
  <<: *with_nix
  <<: *in_dev_branch
  stage: test

pages:
  <<: *with_nix
  <<: *in_prod_branch
  stage: deploy
  artifacts:
    paths: [public/]

release_to_pypi:
  <<: *with_nix
  <<: *in_prod_branch
  stage: release_to_pypi

release_to_docker_hub:
  <<: *with_nix
  <<: *in_prod_branch
  stage: release_to_docker

# Build2

.with_nix_2: &with_nix_2
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:$CI_JOB_NAME"
  needs: []
  script:
    - ./build2.sh "${CI_JOB_NAME% *}"
  interruptible: true

.in_schedule_nightly_build: &in_schedule_nightly_build
  rules:
    - if: '$NIGHTLY_BUILD == "NIGHTLY_BUILD"'
      when: always

build_nix_caches:
  <<: *with_nix_2
  <<: *in_schedule_nightly_build
  tags: [autoscaling-large]
  image: nixos/nix:2.3
  stage: build
  before_script:
    - apk add --no-cache bash
  parallel: 20
  interruptible: false

# For some reason our innovation account is empty!
#   disabling until we recreate it or found how to revert changes
.test_asserts_api_cloud_aws_api:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_cloud_aws_cloudformation:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_cloud_aws_terraform:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_cloud_azure:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_cloud_gcp:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_cloud_kubernetes:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_db_mssql:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_db_mysql:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_db_postgres:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_format:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test
  tags: [autoscaling-large]

test_asserts_api_helper:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_iot:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_core:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_csharp:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_docker:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_dotnetconfig:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_html:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_java:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_javascript:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_php:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_python:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_rpgle:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_lang_times:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_ot:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_dns:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_ftp:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_git:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_graphql:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_http:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_ldap:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_rest:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_smb:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_smtp:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_ssh:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_ssl:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_proto_tcp:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_sca:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_syst:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_asserts_api_utils:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

test_commit_message:
  <<: *with_nix_2
  <<: *in_dev_branch
  stage: test

send_new_release_email:
  <<: *with_nix_2
  <<: *in_prod_branch
  stage: notify

danger:
  image: fluidattacks/danger-ruby
  stage: at-mr
  tags: [autoscaling]
  only:
    - merge_requests
  variables:
    DANGER_GITLAB_API_TOKEN: $DANGER_TOKEN
  before_script:
    - curl -LOJ https://static-objects.gitlab.net/fluidattacks/public/raw/master/commitlint-configs/others/parser-preset.js
    - curl -LOJ https://static-objects.gitlab.net/fluidattacks/public/raw/master/commitlint-configs/others/commitlint.config.js
    - export CI_MERGE_REQUEST_ID=$(git ls-remote -q origin merge-requests\*\head
      | grep ${CI_COMMIT_SHA}
      | sed 's/.*refs\/merge-requests\/\([0-9]*\)\/head/\1/g')
    - npm install @commitlint/{config-conventional,cli}
  script:
    - danger --verbose --fail-on-errors=true
