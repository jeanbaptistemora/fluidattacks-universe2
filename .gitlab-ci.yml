stages:
  - build
  - test
  - mr-test
  - deploy-infra
  - deploy
  - postdeploy

.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:$CI_JOB_NAME"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true

.in_schedule_nightly_build: &in_schedule_nightly_build
  only:
    refs:
      - schedules
    variables:
      - $NIGHTLY_BUILD

.except_master_branch: &except_master_branch
  except:
    refs:
      - master

.in_master_branch: &in_master_branch
  only:
    refs:
      - master

build_nix_caches:
  <<: *with_nix
  <<: *in_schedule_nightly_build
  tags: [autoscaling-large]
  image: nixos/nix:2.3
  stage: build
  before_script:
    - apk add --no-cache bash
  parallel: 11
  interruptible: false

infra_ephemeral_test:
  <<: *with_nix
  stage: test

infra_production_test:
  <<: *with_nix
  stage: test

infra_secret_management_test:
  <<: *with_nix
  stage: test

infra_ephemeral_apply:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy-infra

infra_production_apply:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy-infra

infra_secret_management_apply:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy-infra

test_lint_code:
  <<: *with_nix
  stage: test

test_images:
  <<: *with_nix
  stage: test

test_generic:
  <<: *with_nix
  stage: test

test_blog:
  <<: *with_nix
  stage: test

test_defends:
  <<: *with_nix
  stage: test

test_commit_msg:
  <<: *with_nix
  stage: test

deploy_ephemeral:
  <<: *with_nix
  <<: *except_master_branch
  stage: deploy
  environment:
    name: ephemeral/${CI_COMMIT_REF_NAME}
    url: https://web.eph.fluidattacks.com/${CI_COMMIT_REF_NAME}/web/
    on_stop: deploy_stop_ephemeral
  cache:
    key: "${CI_COMMIT_REF_NAME}-${CI_JOB_NAME}"
    paths:
    - cache/
    - new/cache/

deploy_stop_ephemeral:
  <<: *with_nix
  <<: *except_master_branch
  stage: deploy
  environment:
    name: ephemeral/${CI_COMMIT_REF_NAME}
    action: stop
  when: manual

deploy_production:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

postdeploy_release_email:
  <<: *with_nix
  <<: *in_master_branch
  stage: postdeploy
  needs: [deploy_production]
  except: [schedules]

reviews:
  <<: *with_nix
  stage: mr-test
  only: [merge_requests]

asserts-static:
  stage: test
  tags: [autoscaling]
  image:
    name: fluidattacks/break-build
    entrypoint: [""]
  needs: []
  before_script:
    - docker pull fluidattacks/break-build
  script:
    - bash <(docker run fluidattacks/break-build
              --static
              --id ${FORCES_ID}
              --secret ${FORCES_SECRET}
              --gitlab-docker-socket-binding
             )
  except:
    - master
  interruptible: true

asserts-dynamic:
  stage: postdeploy
  tags: [autoscaling]
  image:
    name: fluidattacks/break-build
    entrypoint: [""]
  before_script:
    - docker pull fluidattacks/break-build
  script:
    - bash <(docker run fluidattacks/break-build
              --dynamic
              --id ${BREAK_BUILD_ID}
              --secret ${BREAK_BUILD_SECRET}
              --gitlab-docker-socket-binding
             )
  only:
    - master
  interruptible: true
