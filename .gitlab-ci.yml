image: registry.gitlab.com/fluidsignal/web:builder

stages:
  - build
  - lint
  - deployment

builder:
  image: docker:17
  services:
    - docker:dind
  stage: build
  script:
    - docker login registry.gitlab.com -u $DOCKER_USER -p $DOCKER_PASSWD
    - docker pull registry.gitlab.com/fluidsignal/web:builder
    # Only builds from scratch if the Dockerfile has changed
    - docker build --cache-from registry.gitlab.com/fluidsignal/web:builder
      -t registry.gitlab.com/fluidsignal/web:builder builder/
    - docker push registry.gitlab.com/fluidsignal/web:builder

checks:
  stage: lint
  script:
    - ./check-changed.sh
    - ./check-all.sh
    - ./sass-lint.sh
    - pelican --fatal errors --fatal warnings content/
    - ./html-lint.sh
  except:
    - master

pages:
  stage: deployment
  environment: staging
  script:
    - sed -i 's/https:\/\/fluid.la//g; s/2014/2018/g; s/output\/web/public/g; s/pages-es/pages-es-2018/g; s/pages-en/pages-en-2018/g' pelicanconf.py
    - sed -i 's/output\/web/public/g' xmlcombine.sh
    - sed -i 's/output/public/g' html-lint.sh
    - pelican --fatal errors --fatal warnings content/
    - ./xmlcombine.sh
    - mv public/en/blog-en public/en/blog && mv public/es/blog-es public/es/blog
    - cp -r public/es/pages-es-2018/* public/es/ && rm -rf public/es/pages-es-2018
    - cp -r public/en/pages-en-2018/* public/en/ && rm -rf public/en/pages-en-2018
    - mv public/en/redirect/index.html public/ && rmdir public/en/redirect/
    - ./html-lint.sh
  artifacts:
    paths:
      - public
  only:
    - master

deploy:
  stage: deployment
  environment: production
  script:
    # Generate the website, exiting on any error encountered
    - pelican --fatal errors --fatal warnings content/
    # Give the folders, named after the language of its content, a general name in each subsite
    - mv output/web/en/blog-en output/web/en/blog && mv output/web/es/blog-es output/web/es/blog
    # Script to generate a complete sitemap of the site
    - ./xmlcombine.sh
    # Remove the language identification used to group documents and images in the same directory
    - cp -r output/web/es/pages-es/* output/web/es/ && rm -rf output/web/es/pages-es
    - cp -r output/web/en/pages-en/* output/web/en/ && rm -rf output/web/en/pages-en
    # Set the redirect from web/ to web/en/
    - mv output/web/en/redirect/index.html output/web/ && rmdir output/web/en/redirect/
    # Upload generated output to S3 bucket
    - aws s3 rm --recursive s3://web.fluid.la
    - aws s3 cp --recursive --acl=public-read-write output/ s3://web.fluid.la
  only:
    - master
