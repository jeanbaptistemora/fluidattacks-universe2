image: docker:latest

variables:
  DOCKER_DRIVER: overlay2

services:
   - docker:dind


before_script:
    - echo $VAULT > /tmp/.vault.txt
    - docker login registry.gitlab.com -u $DOCKER_USER -p $DOCKER_PASS

codequality:
  script:
    - docker pull codeclimate/codeclimate
    - docker run --env CODECLIMATE_CODE="$PWD" --volume "$PWD":/code --volume /var/run/docker.sock:/var/run/docker.sock --volume /tmp/cc:/tmp/cc codeclimate/codeclimate analyze -e sonar-python -e pep8 -e randon -f json > codeclimate.json
  artifacts:
    paths: [codeclimate.json]

stages:
    - build
    - deploy

build_base:
    stage: build
    script:
        - sh containers/base/build.sh
        - docker push registry.gitlab.com/fluidsignal/serves:base

build_alg:
    stage: build
    script:
        - sh containers/alg/build.sh
        - docker push registry.gitlab.com/fluidsignal/serves/alg:base

build_exams:
    stage: build
    script:
        - sh containers/exams/build.sh
        - docker push registry.gitlab.com/fluidsignal/serves/exams:base

build_integrates:
    stage: build
    script:
        - sh containers/integrates/build.sh
        - docker push registry.gitlab.com/fluidsignal/integrates:base

build_vpn:
    stage: build
    script:
        - sh containers/vpn/build.sh
        - docker push registry.gitlab.com/fluidsignal/serves/vpn:base

deploy_alg:
    stage: deploy
    script:
        - docker pull registry.gitlab.com/fluidsignal/serves/alg:base
        - docker tag registry.gitlab.com/fluidsignal/serves/alg:base registry.gitlab.com/fluidsignal/serves/alg:master
        - docker push registry.gitlab.com/fluidsignal/serves/alg:master
    only:
    - master

deploy_exams:
    stage: deploy
    script:
        - docker pull registry.gitlab.com/fluidsignal/serves/exams:base
        - docker tag registry.gitlab.com/fluidsignal/serves/exams:base registry.gitlab.com/fluidsignal/serves/exams:master
        - docker push registry.gitlab.com/fluidsignal/serves/exams:master
    only:
    - master

deploy_vpn:
    stage: deploy
    script:
        - docker pull registry.gitlab.com/fluidsignal/serves/vpn:base
        - docker tag registry.gitlab.com/fluidsignal/serves/vpn:base registry.gitlab.com/fluidsignal/serves/vpn:master
        - docker push registry.gitlab.com/fluidsignal/serves/vpn:master
    only:
    - master