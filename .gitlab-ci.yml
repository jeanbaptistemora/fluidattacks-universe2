stages:
  - terraform-backend
  - build-and-test
  - analytics
  - mr-check
  - deploy
  - eks-initial-setup
  - postdeploy
  - rotation

.in_dev_branch: &in_dev_branch
  except:
    refs:
      - master
      - triggers
      - schedules

.in_dev_and_master_branch: &in_dev_and_master_branch
  except:
    refs:
      - triggers
      - schedules

.in_master_branch: &in_master_branch
  only:
    refs:
      - master
  except:
    refs:
      - triggers
      - schedules

.in_schedules: &in_schedules
  only:
    refs:
      - schedules

.in_schedule_deploy_nix_docker_images: &in_schedule_deploy_nix_docker_images
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_DEPLOY_NIX_DOCKER_IMAGES

.in_schedule_nightly_build: &in_schedule_nightly_build
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_NIGHTLY_BUILD

.in_schedule_user_provision_rotate_keys: &in_schedule_user_provision_rotate_keys
  only:
    refs:
      - schedules
    variables:
      - $SCHEDULE_USER_PROVISION_ROTATE_KEYS

.with_nix: &with_nix
  image: "${CI_REGISTRY_IMAGE}:nix"
  tags: [autoscaling]
  script:
    - ./build.sh "${CI_JOB_NAME}"
  interruptible: true

analytics_formstack:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_FORMSTACK]

analytics_dynamodb:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_DYNAMODB]

analytics_continuous_toe:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_CONTINUOUS_TOE]

analytics_infrastructure:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_INFRASTRUCTURE]

analytics_intercom:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_INTERCOM]

analytics_git:
  <<: *with_nix
  tags: [autoscaling-large]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_GIT]

analytics_mandrill:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_MANDRILL]

analytics_gitlab:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_GITLAB]

analytics_zoho:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_ZOHO]

deploy_docker_image_exams:
  <<: *with_nix
  <<: *in_dev_and_master_branch
  stage: build-and-test

deploy_docker_image_nix:
  <<: *with_nix
  <<: *in_schedule_deploy_nix_docker_images
  stage: build-and-test

deploy_docker_image_vpn:
  <<: *with_nix
  <<: *in_dev_and_master_branch
  stage: build-and-test

infra_analytics_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

infra_analytics_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

infra_autoscaling_ci_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

infra_autoscaling_ci_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

infra_aws_sso_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

infra_aws_sso_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

.infra_fluid_eks_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

.infra_fluid_eks_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

.infra_fluid_eks_setup:
  <<: *with_nix
  <<: *in_master_branch
  stage: eks-initial-setup

infra_fluid_vpc_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

infra_fluid_vpc_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

infra_monolith_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

infra_monolith_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

infra_sops_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

infra_sops_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

lint_code:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

run_break_build_static:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

run_break_build_dynamic:
  <<: *with_nix
  <<: *in_master_branch
  stage: postdeploy

send_new_version_email:
  <<: *with_nix
  <<: *in_master_branch
  when: always
  stage: postdeploy

user_provision_continuous_dev_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

user_provision_continuous_dev_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

user_provision_continuous_dev_rotate_keys:
  <<: *with_nix
  <<: *in_schedule_user_provision_rotate_keys
  stage: rotation

user_provision_continuous_prod_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

user_provision_continuous_prod_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

user_provision_continuous_prod_rotate_keys:
  <<: *with_nix
  <<: *in_schedule_user_provision_rotate_keys
  stage: rotation

user_provision_integrates_dev_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

user_provision_integrates_dev_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

user_provision_integrates_dev_rotate_keys:
  <<: *with_nix
  <<: *in_schedule_user_provision_rotate_keys
  stage: rotation

user_provision_integrates_prod_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

user_provision_integrates_prod_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

user_provision_integrates_prod_rotate_keys:
  <<: *with_nix
  <<: *in_schedule_user_provision_rotate_keys
  stage: rotation

user_provision_web_dev_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

user_provision_web_dev_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

user_provision_web_dev_rotate_keys:
  <<: *with_nix
  <<: *in_schedule_user_provision_rotate_keys
  stage: rotation

user_provision_web_prod_test:
  <<: *with_nix
  <<: *in_dev_branch
  stage: build-and-test

user_provision_web_prod_deploy:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy

user_provision_web_prod_rotate_keys:
  <<: *with_nix
  <<: *in_schedule_user_provision_rotate_keys
  stage: rotation

terraform_states_bucket:
  <<: *with_nix
  <<: *in_master_branch
  stage: terraform-backend

commitlint:
  image: starefossen/ruby-node:2-10
  tags: [autoscaling]
  stage: build-and-test
  before_script:
    - npm install --unsafe-perm
  script:
    - ./ci-scripts/commitlint-checks.sh
  except:
    - master
    - schedules

danger:
  image: fluidattacks/danger-ruby
  tags: [autoscaling]
  stage: mr-check
  only:
    - merge_requests
  variables:
    DANGER_GITLAB_API_TOKEN: $DANGER_TOKEN
  before_script:
    - export CI_MERGE_REQUEST_ID=$(git ls-remote -q origin merge-requests\*\head
      | grep ${CI_COMMIT_SHA}
      | sed 's/.*refs\/merge-requests\/\([0-9]*\)\/head/\1/g')
    - npm install --unsafe-perm
  script:
    - danger --verbose --fail-on-errors=true

fluidasserts_post:
  tags: [autoscaling]
  stage: postdeploy
  image: fluidattacks/asserts
  script:
    - asserts asserts/exploit.py
  only:
    - master
  except:
    - schedules
