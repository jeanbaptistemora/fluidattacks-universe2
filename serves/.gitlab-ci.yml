.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true

.serves_commit_pattern: &serves_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|serves)/'

.in_dev_branch_serves: &in_dev_branch_serves
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *serves_commit_pattern

.in_master_branch_serves: &in_master_branch_serves
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *serves_commit_pattern

serves_test_lint_code:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: lint-code

serves_test_infra_monolith:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_autoscaling_ci:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_dns:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_analytics:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_aws_sso:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_fluid_vpc:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_certificates:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_infra_secret_management:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_asserts_dev:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_asserts_prod:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_services_dev:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_services_prod:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_integrates_dev:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_integrates_prod:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_web_dev:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_web_prod:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_test_user_provision_serves:
  <<: *with_nix
  <<: *in_dev_branch_serves
  stage: test-infra

serves_apply_infra_monolith:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_autoscaling_ci:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_dns:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_analytics:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_aws_sso:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_fluid_vpc:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_secret_management:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_infra_certificates:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_config_autoscaling_ci:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_asserts_dev:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_asserts_prod:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_services_dev:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_services_prod:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_integrates_dev:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_integrates_prod:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_web_dev:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_web_prod:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra

serves_apply_user_provision_serves:
  <<: *with_nix
  <<: *in_master_branch_serves
  stage: deploy-infra
