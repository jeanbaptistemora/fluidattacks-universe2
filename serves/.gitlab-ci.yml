.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true
  variables:
    GIT_DEPTH: 5

.makes: &makes
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/makes:ci"
  needs: []
  interruptible: true
  script:
    - ./make "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.serves_commit_pattern: &serves_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|serves)/'

.serves_in_dev_branch: &serves_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *serves_commit_pattern

.serves_in_master_branch: &serves_in_master_branch
  resource_group: "${CI_JOB_NAME}"
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *serves_commit_pattern

.serves_in_schedule_rotate_keys_user_provision: &serves_in_schedule_rotate_keys_user_provision
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: never
    - if:  '$serves_in_schedule_rotate_keys_user_provision == null'
      when: never
    - when: always

serves_test_lint_code:
  <<: *with_nix
  <<: *serves_in_dev_branch
  stage: lint-code

serves/ci/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/ci/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/aws-sso/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/aws-sso/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/secrets/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/secrets/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/compute/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/compute/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/dns/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/dns/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/vpc/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/vpc/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/airs/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/airs/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/asserts/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/asserts/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/forces/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/forces/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/integrates/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/integrates/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/melts/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/melts/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/serves/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/serves/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/services/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/services/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/skims/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/skims/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves/users/sorts/test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra

serves/users/sorts/apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves_test_user_provision_observes:
  <<: *with_nix
  <<: *serves_in_dev_branch
  stage: test-infra

serves_apply_config_autoscaling_ci:
  <<: *with_nix
  <<: *serves_in_master_branch
  stage: deploy-infra

serves_apply_user_provision_observes:
  <<: *with_nix
  <<: *serves_in_master_branch
  stage: deploy-infra

serves_rotate_keys_user_provision_asserts:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_services:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_integrates:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_airs:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_serves:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_melts:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_observes:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_skims:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation

serves_rotate_keys_user_provision_sorts:
  <<: *with_nix
  <<: *serves_in_schedule_rotate_keys_user_provision
  stage: rotation
