.makes: &makes
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/makes"
  needs: []
  interruptible: true
  script:
    - ./m "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.serves_commit_pattern: &serves_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|serves)/'

.serves_in_dev_branch: &serves_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *serves_commit_pattern

.serves_in_master_branch: &serves_in_master_branch
  resource_group: "${CI_JOB_NAME}"
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *serves_commit_pattern

.serves_in_schedule_users_rotate_even: &serves_in_schedule_users_rotate_even
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: never
    - if: '$serves_users_rotate_even != "defined"'
      when: never
    - when: always

.serves_in_schedule_users_rotate_odd: &serves_in_schedule_users_rotate_odd
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
      when: never
    - if: '$serves_users_rotate_odd != "defined"'
      when: never
    - when: always

makes.test.serves:
  <<: *makes
  <<: *serves_in_master_branch
  stage: test-code

serves.vpc.apply:
  <<: *makes
  <<: *serves_in_master_branch
  stage: deploy-infra

serves.vpc.test:
  <<: *makes
  <<: *serves_in_dev_branch
  stage: test-infra
