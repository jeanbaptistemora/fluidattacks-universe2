.with_nix_serial: &with_nix_serial
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  tags: [autoscaling]
  script:
    - ./build.sh "${CI_JOB_NAME% *}"

analytics_formstack:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_FORMSTACK]
  interruptible: false

analytics_dynamodb:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_DYNAMODB]
  interruptible: false

analytics_services_toe:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_CONTINUOUS_TOE]
  interruptible: false

analytics_infrastructure:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_INFRASTRUCTURE]
  interruptible: false

analytics_intercom:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_INTERCOM]
  interruptible: false

analytics_mandrill:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_MANDRILL]
  interruptible: false

analytics_gitlab:
  <<: *with_nix
  tags: [autoscaling]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_GITLAB]
  interruptible: false

analytics_timedoctor:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_TIMEDOCTOR]
  interruptible: false

analytics_zoho:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_ZOHO]
  interruptible: false

analytics_git_process:
  <<: *with_nix_serial
  image: "${CI_REGISTRY_IMAGE}/nix:analytics_git_process"
  tags: [autoscaling-analytics]
  stage: analytics
  artifacts:
    paths:
      - artifacts/
    when: always
    expire_in: 1 day
  parallel: 50
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_GIT_PARALLEL]
  interruptible: false

analytics_git_upload:
  <<: *with_nix_serial
  tags: [autoscaling-analytics]
  stage: analytics-upload
  artifacts:
    paths:
      - artifacts/
    when: always
    expire_in: 1 day
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_GIT_PARALLEL]
  interruptible: false

analytics_timedoctor_refresh_token:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_ANALYTICS_TIMEDOCTOR_REFRESH_TOKEN]
  interruptible: false

analytics_timedoctor_backup:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_BACKUP_ANALYTICS_TIMEDOCTOR]
  interruptible: false

analytics_services_repositories_cache:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$SCHEDULE_SERVICES_REPOSITORIES_CACHE]
  interruptible: false
