include:
  - local: observes/common/singer_io/.gitlab-ci.yml
  - local: observes/code_etl/.gitlab-ci.yml
  - local: observes/infra/.gitlab-ci.yml
  - local: observes/singer/tap_announcekit/.gitlab-ci.yml
  - local: observes/singer/tap_bugsnag/.gitlab-ci.yml
  - local: observes/singer/tap_csv/.gitlab-ci.yml
  - local: observes/singer/tap_gitlab/.gitlab-ci.yml
  - local: observes/singer/tap_mailchimp/.gitlab-ci.yml
  - local: observes/singer/tap_mixpanel/.gitlab-ci.yml

.makes: &makes
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/makes"
  interruptible: true
  script:
    - ./m "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.commit_pattern: &commit_pattern '$CI_COMMIT_TITLE =~ /^(all|observes)/'

.observes_in_dev_branch: &observes_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *commit_pattern

.master_job: &master_job
  resource_group: "${CI_JOB_NAME}"
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *commit_pattern
      changes:
        - observes/*

.lint_job: &lint_job
  <<: *makes
  <<: *observes_in_dev_branch
  needs: []
  stage: lint-code

.scheduled: &scheduled
  <<: *makes
  only:
      refs: [schedules]
      variables:
        - '$observes_scheduled_job == $CI_JOB_NAME'
  stage: analytics
  interruptible: false

.scheduled_job: &scheduled_job
  <<: *scheduled
  tags: [autoscaling]

.scheduled_job_large: &scheduled_job_large
  <<: *scheduled
  tags: [autoscaling-large]

# lint jobs

observes.lint.paginator:
  <<: *lint_job

observes.lint.postgres-client:
  <<: *lint_job

observes.lint.tap-checkly:
  <<: *lint_job

observes.lint.tap-delighted:
  <<: *lint_job

# scheduled jobs

observes.scheduled.job.batch-stability:
  <<: *scheduled_job

observes.scheduled.job.code-etl-compute-bills:
  <<: *scheduled_job

observes.scheduled.job.dynamodb-centralize:
  <<: *scheduled_job

observes.scheduled.job.dynamodb-integrates-etl-vulns:
  <<: *scheduled_job_large

observes.scheduled.job.mailchimp-etl:
  <<: *scheduled_job

observes.scheduled.job.mixpanel-integrates-etl:
  <<: *scheduled_job

observes.scheduled.job.scheduler:
  <<: *scheduled_job

observes.scheduled.job.tap-zoho-analytics:
  <<: *scheduled_job

observes.scheduled.job.timedoctor-backup:
  <<: *scheduled_job

observes.scheduled.job.timedoctor-etl:
  <<: *scheduled_job

observes.scheduled.job.timedoctor-refresh-token:
  <<: *scheduled_job

observes.scheduled.job.toe-files-etl:
  <<: *scheduled_job

observes.scheduled.job.zoho-crm-etl.fluid:
  <<: *scheduled_job

observes.scheduled.job.zoho-crm-prepare.fluid:
  <<: *scheduled_job

observes.scheduled.on-aws.code-etl-mirror:
  <<: *scheduled_job

observes.scheduled.on-aws.code-etl-upload:
  <<: *scheduled_job

# test jobs

makes.test.observes:
  <<: *makes
  <<: *master_job
  stage: test-code
  needs: []
