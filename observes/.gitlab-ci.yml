.with_nix_serial: &with_nix_serial
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true
  variables:
    GIT_DEPTH: 5

.observes_commit_pattern: &observes_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|observes)/'

.observes_in_dev_branch: &observes_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *observes_commit_pattern

.observes_in_master_branch: &observes_in_master_branch
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *observes_commit_pattern

observes_test_infra:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: test-infra

observes_apply_infra:
  <<: *with_nix
  <<: *observes_in_master_branch
  stage: deploy-infra

# Schedules

observes_formstack:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_formstack]
  interruptible: false

observes_dynamodb:
  <<: *with_nix
  tags: [autoscaling-large]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_dynamodb]
  interruptible: false

observes_dynamodb_forces_on_aws:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_dynamodb_forces_on_aws]
  interruptible: false

observes_services_toe:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_services_toe]
  interruptible: false

observes_gitlab_on_aws:
  <<: *with_nix
  tags: [autoscaling]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_gitlab_on_aws]
  interruptible: false

observes_gitlab_streamer_lint:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: lint-code

observes_gitlab_streamer_test:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: test-code

observes_gitlab_etl_lint:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: lint-code

observes_gitlab_etl_test:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: test-code

observes_tredshift_lint:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: lint-code

observes_tredshift_test:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: test-code

observes_zoho_crm_lint:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: lint-code

observes_zoho_crm_test:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: lint-code

observes_code_lint:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: lint-code

observes_code_test:
  <<: *with_nix
  <<: *observes_in_dev_branch
  stage: test-code

observes_timedoctor:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_timedoctor]
  interruptible: false

observes_zoho:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_zoho]
  interruptible: false

observes_git_process:
  <<: *with_nix_serial
  image: "${CI_REGISTRY_IMAGE}/nix:observes_git_process"
  tags: [autoscaling-analytics]
  stage: analytics
  artifacts:
    paths:
      - artifacts/
    when: always
    expire_in: 1 day
  parallel: 50
  only:
    refs: [schedules]
    variables: [$observes_git_process]
  interruptible: false

observes_git_upload:
  <<: *with_nix_serial
  tags: [autoscaling-analytics]
  stage: analytics-upload
  artifacts:
    paths:
      - artifacts/
    when: always
    expire_in: 1 day
  only:
    refs: [schedules]
    variables: [$observes_git_upload]
  interruptible: false

observes_code_upload_all_groups_on_aws:
  <<: *with_nix_serial
  only:
    refs: [schedules]
    variables: [$observes_code_upload_all_groups_on_aws]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes_code_amend_authors_on_aws:
  <<: *with_nix_serial
  only:
    refs: [schedules]
    variables: [$observes_code_amend_authors_on_aws]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes_code_compute_bills:
  <<: *with_nix_serial
  only:
    refs: [schedules]
    variables: [$observes_code_compute_bills]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes_code_mirror_all_groups_to_s3_on_aws:
  <<: *with_nix_serial
  only:
    refs: [schedules]
    variables: [$observes_code_mirror_all_groups_to_s3_on_aws]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes_batch_stability:
  <<: *with_nix_serial
  only:
    refs: [schedules]
    variables: [$observes_batch_stability]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes_timedoctor_refresh_token:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_timedoctor_refresh_token]
  interruptible: false

observes_timedoctor_backup:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_timedoctor_backup]
  interruptible: false
