.makes: &makes
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/makes:ci"
  needs: []
  interruptible: true
  script:
    - ./m "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.with_nix_serial: &with_nix_serial
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true
  variables:
    GIT_DEPTH: 5

.observes_commit_pattern: &observes_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|observes)/'

.observes_in_dev_branch: &observes_in_dev_branch
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *observes_commit_pattern

.observes_in_master_branch: &observes_in_master_branch
  resource_group: "${CI_JOB_NAME}"
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *observes_commit_pattern

makes.test.observes:
  <<: *makes
  <<: *observes_in_master_branch
  stage: test-code

observes.infra-test:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-infra

observes.lint-code-etl:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-dif-gitlab-etl:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-postgres-client:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint.service-migrate-tables:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-singer-io:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-streamer-gitlab:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-streamer-zoho-crm:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-tap-csv:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-tap-formstack:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint.tap-mailchimp:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-tap-mixpanel:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-target-redshift:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.lint-update-sync-date:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: lint-code

observes.scheduled.code-etl-amend:
  <<: *makes
  only:
    refs: [schedules]
    variables: [$observes_code_amend_authors_on_aws]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes.scheduled.code-etl-compute-bills:
  <<: *makes
  only:
    refs: [schedules]
    variables: [$observes_code_compute_bills]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes.scheduled.code-etl-mirror:
  <<: *makes
  only:
    refs: [schedules]
    variables: [$observes_code_mirror_all_groups_to_s3_on_aws]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes.scheduled.code-etl-upload:
  <<: *makes
  only:
    refs: [schedules]
    variables: [$observes_code_upload_all_groups_on_aws]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes.scheduled.dynamodb-centralize:
  <<: *makes
  tags: [autoscaling-large]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_dynamodb_centralize]
  interruptible: false

observes.scheduled.dynamodb-integrates-etl:
  <<: *makes
  tags: [autoscaling-large]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_dynamodb]
  interruptible: false

observes.scheduled.dynamodb-integrates-etl-vulns:
  <<: *makes
  tags: [autoscaling-large]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_dynamodb_vulns]
  interruptible: false

observes.scheduled.formstack-etl:
  <<: *makes
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_formstack]
  interruptible: false

observes.scheduled.mixpanel-integrates-etl:
  <<: *makes
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_mixpanel_integrates]
  interruptible: false

observes.scheduled.timedoctor-backup:
  <<: *makes
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_timedoctor_backup]
  interruptible: false

observes.scheduled.timedoctor-etl:
  <<: *makes
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_timedoctor]
  interruptible: false

observes.scheduled.zoho-crm-etl:
  <<: *makes
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_zoho_crm]
  interruptible: false

observes.scheduled.zoho-crm-prepare:
  <<: *makes
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_zoho_crm_prepare]
  interruptible: false

observes.test-code-etl:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-dif-gitlab-etl:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-postgres-client:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-singer-io:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-streamer-gitlab:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-streamer-zoho-crm:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-tap-csv:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

observes.test-target-redshift:
  <<: *makes
  <<: *observes_in_dev_branch
  stage: test-code

# disorganized jobs

observes_apply_infra:
  <<: *with_nix
  <<: *observes_in_master_branch
  stage: deploy-infra

observes_dynamodb_forces_on_aws:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_dynamodb_forces_on_aws]
  interruptible: false

observes_services_toe:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_services_toe]
  interruptible: false

observes_gitlab_on_aws:
  <<: *with_nix
  tags: [autoscaling]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_gitlab_on_aws]
  interruptible: false

observes_zoho:
  <<: *with_nix
  tags: [autoscaling-analytics]
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_zoho]
  interruptible: false

observes_batch_stability:
  <<: *with_nix_serial
  only:
    refs: [schedules]
    variables: [$observes_batch_stability]
  stage: analytics
  tags: [autoscaling]
  interruptible: false

observes_timedoctor_refresh_token:
  <<: *with_nix
  stage: analytics
  only:
    refs: [schedules]
    variables: [$observes_timedoctor_refresh_token]
  interruptible: false
