---
- hosts: localhost

  become: "yes"

  tasks:
   - name: Incluir llaves de cifrado
     include_vars: vars/key.yml

   - name: Incluir variables de configuracion
     include_vars: vars/vars.yml

   - name: Instalar Dependencias
     apt:
      pkg: "{{ item }}"
      state: installed
     register: apacheinstalled
     notify:
      - iniciar apache2
     with_items:
      - apache2
      - curl
      - python-pip
      - python-dev
      - libffi-dev
      - libssl-dev
      - g++
      - gcc

   - name: Upgrade setuptools
     pip:
      name: "{{ item }}"
      extra_args: -U --force
     with_items:
      - pip
      - setuptools

   - name: Habilitar modulos necesarios de Apache
     command: a2enmod {{ item }}
     with_items:
      - rewrite
      - ssl
      - proxy_http
      - substitute
      - headers
     notify:
      - reiniciar apache2
     when: apacheinstalled


   - name: Creando configuraci√≥n Apache
     template:
      src: "vars/apache2.j2"
      dest: "/etc/apache2/apache2.conf"
      mode: "0644"

   - name: Creando sitio por defecto
     template:
      src: "vars/000-default.j2"
      dest: "/etc/apache2/sites-enabled/000-default.conf"
      mode: "0644"

   - name: Creando fluid.la
     template:
      src: "vars/fluid.la.j2"
      dest: "/etc/apache2/sites-enabled/fluid.la"
      mode: "0644"

   - name: Creando fluidattacks.com
     template:
      src: "vars/fluidattacks.j2"
      dest: "/etc/apache2/sites-enabled/fluidattacks.com"
      mode: "0644"

   - name: Creando www.fluid.la
     template:
      src: "vars/www.fluid.la.j2"
      dest: "/etc/apache2/sites-enabled/www.fluid.la"
      mode: "0644"

   - name: Creando fluidsignal.com
     template:
      src: "vars/fluidsignal.com.j2"
      dest: "/etc/apache2/sites-enabled/fluidsignal.com"
      mode: "0644"

   - name: Creando fluidsignal.co
     template:
      src: "vars/fluidsignal.co.j2"
      dest: "/etc/apache2/sites-enabled/fluidsignal.co"
      mode: "0644"

   - name: Creando fluidsignal.com.co
     template:
      src: "vars/fluidsignal.com.co.j2"
      dest: "/etc/apache2/sites-enabled/fluidsignal.com.co"
      mode: "0644"

   - name: Creando fluid.com.co
     template:
      src: "vars/fluid.com.co.j2"
      dest: "/etc/apache2/sites-enabled/fluid.com.co"
      mode: "0644"

   - name: Creando sitio ssl
     template:
      src: "vars/defaultssl.j2"
      dest: "/etc/apache2/sites-enabled/default-ssl"
      mode: "0644"

   - name: Creando sitio ssl
     template:
      src: "vars/fluidattacksssl.j2"
      dest: "/etc/apache2/sites-enabled/fluidattacks-ssl"
      mode: "0644"

   - name: Retirar index
     file:
      path: "/var/www/html/index.html"
      state: absent

   - name: Instalando certificado digital
     copy:
      content: '{{ ssl_cert }}'
      dest: /etc/ssl/certs/fluidla.crt
      owner: root
      group: root
      mode: 0644

   - name: Instalando nuevo certificado digital
     copy:
      content: '{{ new_ssl_cert }}'
      dest: /etc/ssl/certs/fluidattackscom.crt
      owner: root
      group: root
      mode: 0644

   - name: Instalando llave privada ssl
     copy:
      content: '{{ ssl_key }}'
      dest: /etc/ssl/private/fluidla.key
      owner: root
      group: root
      mode: 0600
     notify:
      - reiniciar apache2
     register: ssl

  handlers:
   - name: reiniciar apache2
     service:
      name: "apache2"
      state: "restarted"

   - name: iniciar apache2
     service:
      name: "apache2"
      state: started
