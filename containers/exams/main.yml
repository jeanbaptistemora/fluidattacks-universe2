---
- hosts: localhost

  become: "yes"

  tasks:
    - name: Include vault vars
      include_vars: vars/vars.yml

    - name: Remove index
      file:
        path: "/var/www/html/index.html"
        state: absent

    - name: Turn on services
      service:
        name: "{{ item }}"
        state: started
        enabled: "yes"
      with_items:
        - apache2
        - cron

    - name: Set up permissions
      file:
        path: "/var/www/html"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: "0755"
        recurse: "yes"

    - name: Download moodle
      git:
        repo: "git://git.moodle.org/moodle.git"
        depth: 1
        dest: "/var/www/html"
        version: "MOODLE_36_STABLE"

    - name: Create directory for Moodle data
      file:
        path: "/var/www/moodledata"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: "0755"
        recurse: "yes"

    - name: Copy moodledata to root
      unarchive:
        src: "vars/moodledata.tar.xz"
        dest: "/"
      register: moodledata

    - name: Install Moodle
      command: >
        /usr/bin/php install.php --non-interactive --wwwroot={{ moodle_host }}
        --dataroot=/var/www/moodledata --dbhost={{ db_host }}
        --dbuser={{ db_username }} --dbpass={{ db_password }}
        --fullname="AutonomicMind Courses" --shortname="Moodle"
        --adminpass={{ admin_password }} --skip-database --agree-license
        chdir=/var/www/html/admin/cli

    - name: Add config.php
      template:
        src: "vars/config.j2"
        dest: "/var/www/html/config.php"
        mode: "0644"

    - name: Update permissions
      file:
        path: "/var/www/html"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: "0755"
        recurse: "yes"

    - name: Download Moodle theme
      get_url:
        url: "https://moodle.org/plugins/download.php/12122/theme_eduhub_moodle31_2016090100.zip"
        dest: "/tmp"

    - name: Install Moodle theme
      unarchive:
        src: "/tmp/theme_eduhub_moodle31_2016090100.zip"
        dest: "/var/www/html/theme"
        copy: "no"

    - name: Download secureexambrowser
      git:
        repo: "git://github.com/moodleou/moodle-quizaccess_safeexambrowser.git"
        dest: "/var/www/html/mod/quiz/accessrule/safeexambrowser"
        version: "v1.3"

    - name: Configure cron
      cron:
        name: "Moodle"
        job: "/usr/bin/php /var/www/html/admin/cli/cron.php >/dev/null"

    - name: Change Memory Limit
      ini_file:
        dest: /etc/php/7.3/apache2/php.ini
        section: PHP
        option: memory_limit
        value: 2048M
