---
- hosts: localhost

  become: "yes"

  tasks:
   - name: Inlcuir variables (Vault)
     include_vars: vars/vars.yml

   - name: Instalar paquetes necesarios
     apt:
      pkg: "{{ item }}"
      state: installed
     register: dependencias
     with_items:
      - apache2
      - php5
      - php5-gd
      - php5-xmlrpc
      - php5-intl
      - php5-mysql
      - php5-curl
      - curl
      - git
      - python-mysqldb
      - unzip
      - cron
      - python-boto

   - name: Retirar index
     file:
      path: "/var/www/html/index.html"
      state: absent

   - name: Habilitar servicios
     service:
      name: "{{ item }}"
      state: started
      enabled: "yes"
     with_items:
      - apache2
      - cron

   - name: Establecer permisos
     file:
      path: "/var/www/html"
      state: directory
      owner: "www-data"
      group: "www-data"
      mode: "0755"
      recurse: "yes"

   - name: Descargando Moodle
     git:
      repo: "git://git.moodle.org/moodle.git"
      dest: "/var/www/html"
      version: "MOODLE_31_STABLE"

   - name: Crear directorio para los datos de Moodle
     file:
      path: "/var/www/moodledata"
      state: directory
      owner: "www-data"
      group: "www-data"
      mode: "0777"
      recurse: "yes"

   - name: Obtener moodledata s3
     s3:
      aws_access_key: "{{aws_access_key}}"
      aws_secret_key: "{{aws_secret_key}}"
      bucket: "{{ s3bucket }}"
      object: "serves/exams/moodledata.tar"
      dest: "/tmp/moodledata.tar"
      mode: get

   - name: Copiar moodledata al directorio
     unarchive:
      src: "/tmp/moodledata.tar"
      dest: "/"
      copy: "no"
     register: moodledata

   - name: Instalar Moodle
     command: >
      /usr/bin/php install.php --non-interactive --wwwroot={{ moodle_host }}
      --dataroot=/var/www/moodledata --dbhost={{ db_host }}
      --dbuser={{ db_username }} --dbpass={{ db_password }}
      --fullname="FLUID Courses" --shortname="Moodle"
      --adminpass={{ admin_password }} --skip-database --agree-license
      chdir=/var/www/html/admin/cli
     when: dependencias

   - name: Agregar config.php
     template:
      src: "vars/config.j2"
      dest: "/var/www/html/config.php"
      mode: "0644"

   - name: Actualizar permisos
     file:
      path: "/var/www/html"
      state: directory
      owner: "www-data"
      group: "www-data"
      mode: "0755"
      recurse: "yes"

   - name: Descargar tema para Moodle
     get_url:
      url: "https://moodle.org/plugins/download.php/12122/theme_eduhub_moodle31_2016090100.zip"
      dest: "/tmp"

   - name: Copiar tema en la ruta indicada
     unarchive:
      src: "/tmp/theme_eduhub_moodle31_2016090100.zip"
      dest: "/var/www/html/theme"
      copy: "no"

   - name: Descargando secureexambrowser
     git:
      repo: "git://github.com/moodleou/moodle-quizaccess_safeexambrowser.git"
      dest: "/var/www/html/mod/quiz/accessrule/safeexambrowser"
      version: "master"

   - name: Configurar cron
     cron:
      name: "Moodle"
      job: "/usr/bin/php /var/www/html/admin/cli/cron.php >/dev/null"

   - name: Change Memory Limit
     ini_file:
      dest: /etc/php5/apache2/php.ini
      section: PHP
      option: memory_limit
      value: 1024M
