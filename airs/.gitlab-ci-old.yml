test_lint_code:
  <<: *with_nix
  stage: test

test_images:
  <<: *with_nix
  stage: test

test_generic:
  <<: *with_nix
  stage: test

test_blog:
  <<: *with_nix
  stage: test

test_defends:
  <<: *with_nix
  stage: test

test_commit_msg:
  <<: *with_nix
  stage: test

deploy_ephemeral:
  <<: *with_nix
  <<: *except_master_branch
  stage: deploy
  environment:
    name: ephemeral/${CI_COMMIT_REF_NAME}
    url: https://web.eph.fluidattacks.com/${CI_COMMIT_REF_NAME}/web/
    on_stop: deploy_stop_ephemeral
  cache:
    key: "${CI_COMMIT_REF_NAME}-${CI_JOB_NAME}"
    paths:
    - cache/
    - new/cache/

deploy_stop_ephemeral:
  <<: *with_nix
  <<: *except_master_branch
  stage: deploy
  environment:
    name: ephemeral/${CI_COMMIT_REF_NAME}
    action: stop
  when: manual

deploy_production:
  <<: *with_nix
  <<: *in_master_branch
  stage: deploy
