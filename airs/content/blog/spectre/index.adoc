:page-slug: spectre/
:page-date: 2021-05-27
:page-subtitle: The one who leaves no trace
:page-category: attacks
:page-tags: cybersecurity, exploit, mistake, risk, technology, software
:page-image: https://res.cloudinary.com/fluid-attacks/image/upload/v1622146610/blog/spectre/cover_vioppv.webp
:page-alt: Photo by Sammy Williams on Unsplash
:page-description: Spectre has reappeared! It has returned full of surprises and can transform the way processors are made. Here is what we know about it.
:page-keywords: Spectre, Vulnerability, Software, Cybersecurity, Speculative Execution, Ethical Hacking, Processor, Pentesting, CPU
:page-author: Felipe Zárate
:page-writer: fzarate
:name: Felipe Zárate
:about1: Cybersecurity Editor
:source: https://unsplash.com/photos/ocvLVIrC7c0

= What's the Perfect Crime?

*Spectre* was in the spotlight of cyber threat news in 2018.
Its name is a direct reference to
the only agent capable of attacking in that way: a specter.
Since every ghost always comes back, Spectre has reappeared!
To start talking about it,
we have prepared a story and a challenge for you.
*Can you solve it?*

Imagine the following scenario:
a businessman increased his company's efficiency
by hiring different people to perform routine tasks
even before someone asked them to do so.
They built filing cabinets to store the most often used documents.
They saved time and increased profits.
If a posteriori instruction contradicted what the employees had done,
they reversed the action and forgot those failed actions.

Some years later, the businessman's lifeless body appeared in his library.
He had a deep wound in his heart with an undue pool of blood.
There was nothing nearby that could have been used to kill him.
The room had doors and windows closed from the inside
with no openings in walls, ceiling, or floor.
The only suspect was an employee
who was with him two hours before his death.
However, after drinking the infallible truth serum,
it was confirmed his innocence.
The victim's sister claims the assassin was a ghost.
But was it?

Clues are already given,
and we can suggest a solution.
But, before that, if you think that this story is merely fiction,
I invite you to read what happened with the Spectre case.

.Photo by link:https://unsplash.com/photos/jZ9TPXjoZQk[Kirill Sharkovski] on Unsplash
image::https://res.cloudinary.com/fluid-attacks/image/upload/v1622051254/blog/spectre/ghosts_ec3lsn.webp[ghosts]

== Spectre

link:https://www.ieee-security.org/TC/SP2019/SP19-Slides-pdfs/Paul_Kocher_01_-_Spectre_Attacks-IEEE-SecurityPrivacy_v05.pdf[Since 2004]
the 3.8GHz Pentium 4
link:https://www.anandtech.com/show/1695["bump in speed from
the already available 6xx line of processors."]
Thanks to that, computers and devices
that work with microchips have increased their efficiency.
Behind that efficiency and increased performance,
there is an effort link:https://www.youtube.com/watch?v=zOvBHxMjNls[to boost
pipeline in average cases],
reduce memory delays by using caches,
and work during delays using *speculative execution*.
That allowed routine processes to be much more efficient.
Now, how did this advantage become a vulnerability?

To answer that, we will explain what *speculative execution*
is by referring to Paul Kocher's talk:
link:https://youtu.be/zOvBHxMjNls[_Spectre Attacks
Exploiting Speculative Execution_].
It was presented in May 2019 under
the link:https://www.ieee-security.org/TC/SP2019/[*40th IEEE Symposium
on security and privacy*].

== Speculative execution

A CPU could start a course of action
without confirming that it is the correct path.
In other words:
link:https://www.computer.org/csdl/pds/api/csdl/proceedings/download-article/19skfbE9KUw/pdf["the
CPU guesses likely future execution directions
and prematurely execute instructions on these paths."]
This means that even before the value that executes an instruction appears,
the CPU is already performing it.

This solution responded to
the limited number of processes a CPU
can execute at the same time.
That number is conditioned by each CPU
link:https://techterms.com/definition/clockcycle#:~:text=A%20clock%20cycle%2C%20or%20simply,processes%20require%20multiple%20clock%20cycles.[clock cycle].
To avoid waiting:

.link:https://www.computer.org/csdl/pds/api/csdl/proceedings/download-article/19skfbE9KUw/pdf[(Kocher et al., 2019)]
image::https://res.cloudinary.com/fluid-attacks/image/upload/v1622204109/blog/spectre/figure1_uygv6x.webp[Figure1]

When the value is known,
a CPU identifies if the speculation was correct.
If so, "the code continues as supposed, and the result would come faster."
If the assumption was wrong

.link:https://www.computer.org/csdl/pds/api/csdl/proceedings/download-article/19skfbE9KUw/pdf[(Kocher et al., 2019)]
image::https://res.cloudinary.com/fluid-attacks/image/upload/v1622204893/blog/spectre/figure2_gqvslb.webp[Figure2]

There is no cost in time or resources since
the alternative option is to wait for the value to be revealed.
Then either the CPU expects data to execute orders
or "get ahead of the job" and perform the process before the command.
However, over time it was seen that
link:https://www.ieee-security.org/TC/SP2019/SP19-Slides-pdfs/Paul_Kocher_01_-_Spectre_Attacks-IEEE-SecurityPrivacy_v05.pdf[there were
security implications from speculative execution].
In fact, the CPU was opening a vulnerability on its own:
a *fault attack* hardware was built-in.

== Fault Attack and Branch Predictor

When a program runs incorrectly,
we are talking about a Fault Attack.
It is a vulnerability that must be taken seriously,
depending on the execution that has been launched (see Figure 4).

One way to change instructions is by taking advantage of *Branch predictors*.
These are architectural units used link:https://spectrum.ieee.org/computing/hardware/how-the-spectre-and-meltdown-hacks-really-worked["to guess where
the next instruction, after a branch, will come from."]
Through them, the CPU speculates whether a conditional branch
will be taken and the possible outcome of the instruction if it is executed.
If the speculation is wrong,
the speculatively executed instruction CPU's effects
will reverse all registry contents back to where it was before proceeding.

.link:https://www.ieee-security.org/TC/SP2019/SP19-Slides-pdfs/Paul_Kocher_01_-_Spectre_Attacks-IEEE-SecurityPrivacy_v05.pdf[Fault Attacks]
image::https://res.cloudinary.com/fluid-attacks/image/upload/v1622051246/blog/spectre/figure3_b7wcaz.webp[Figure3]

== Out-of-bounds and primary solution

The CPU performs a perfectly legal
link:https://docs.fluidattacks.com/types/111/[out-of-bounds], i.e.,
link:https://cwe.mitre.org/data/definitions/125.html["the software
reads data past the end,
or before the beginning, of the intended buffer."]
But what does this mean?
The Buffer is a memory piece in the processor
that allows returning from cache or temporary memory
to complete long-lasting memory addresses.
Here is where a security breach is performed.
In Kocher's words, the problem is that:
[quote]
"if you can come up with really any kind of an error
that will change some instruction
by choosing when to use these errors and how you use them,
you can turn any program into something that is exploitable."
(link:https://youtu.be/zOvBHxMjNls?t=331[Spectre Attacks Exploiting]).

What is astonishing is that it is not only allowed,
but it is integrated into CPU operations.

This vulnerability has been widely known and analyzed.
Since 2018, when it first came to light,
Intel and AMD, two of the world's biggest processor companies, adjusted
link:https://spectrum.ieee.org/computing/hardware/how-the-spectre-and-meltdown-hacks-really-worked["their microcode to change the behavior
of some assembly-language instructions in ways that limit speculation."]
Their solution was to limit "spaces" in which speculation is allowed.
By doing so, they made specific processing moments safer but slower.

== Spectre reappearance

A recent paper published by the University of Virginia
concludes that this threat is not over yet.
link:https://engineering.virginia.edu/news/2021/04/defenseless-uva-engineering-computer-scientists-discover-vulnerability-affecting[Researchers have]
"uncovered a line of attack that breaks all Spectre defenses,"
which means that "billions of computers
and other devices across the globe are just as vulnerable today
as they were when Spectre was first announced."

Specifications of this new threat
can be reviewed in their
link:https://www.cs.virginia.edu/venkat/papers/isca2021a.pdf[article (Ren et al., 2021).]
However, the main risk identified in their study is that
Spectre vulnerability is not in the software but in the hardware.
Notably, Intel, AMD, and AMR processors use
link:https://erik-engheim.medium.com/what-the-heck-is-a-micro-operation-e991f76209e[micro-ops]
to process complex instructions into small micro-op caches.
And published research describes
"attacks that exploit the micro-op cache
as a timing channel to transmit secret information."
As a result of those attacks,
criminals can leak secrets in three primary settings
(see those settings in detail
link:https://www.cs.virginia.edu/venkat/papers/isca2021a.pdf[here]).

Although this finding is recent
and will be publicly discussed this year in June at the
link:https://www.iscaconf.org/isca2021/program/[*International Symposium
on Computer Architecture*],
the team that wrote the paper has already talked
to Intel and AMD about their findings.
On May 4, an link:https://itwire.com/security/us-researchers-find-flaw-affecting-processors-made-since-2011.html[Intel spokesman said]:
"that existing mitigations were not being bypassed
and that this scenario was addressed in its secure coding guidance."
Still, that response is quite disappointing
because the problem should not be solved using constant-time programming.
Instead, it should be fixed from its source: processors.
As Ashish Venkant, one of the paper's authors, said:
[quote]
link:https://engineering.virginia.edu/news/2021/04/defenseless-uva-engineering-computer-scientists-discover-vulnerability-affecting["
the vulnerability we uncovered is in hardware,
and it is important to also design processors
that are secure and resilient against these attacks."]

.Photo by link:https://unsplash.com/photos/By-tZImt0Ms[Sigmund] on Unsplash
image::https://res.cloudinary.com/fluid-attacks/image/upload/v1622051253/blog/spectre/game_over_ajkshq.webp[Game Over]

== Not-so-perfect crime

Let us go back to our crime scene.
By using the Spectre explanation,
did you discover what happened there?

The key is in the truth serum test:
the employee had to be the killer, but he does not remember it.
Anyway, we still have another mystery:
what did he use to get through the victim's heart?
The answer is, perhaps, in the excessive pool of blood.
If there was a way to make an object disappear in a couple of hours…
Can you think of what it could be?

.Photo by link:https://unsplash.com/photos/zwd_QW8JB7g[Yannic Kress] on Unsplash
image::https://res.cloudinary.com/fluid-attacks/image/upload/v1622051251/blog/spectre/ice_ounl8h.webp[Ice]

We hope you have enjoyed this post,
and we look forward to hearing from you.
link:../../contact-us/[Contact us!]
