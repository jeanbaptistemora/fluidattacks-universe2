.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true

.airs_commit_pattern: &airs_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|airs)/'

.in_dev_branch_airs: &in_dev_branch_airs
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *airs_commit_pattern

.in_master_branch_airs: &in_master_branch_airs
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *airs_commit_pattern

.in_dev_and_master_branch_airs: &in_dev_and_master_branch_airs
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *airs_commit_pattern

airs_infra_ephemeral_test:
  <<: *with_nix
  <<: *in_dev_branch_airs
  stage: test-infra

airs_infra_ephemeral_apply:
  <<: *with_nix
  <<: *in_master_branch_airs
  stage: deploy-infra

airs_infra_production_test:
  <<: *with_nix
  <<: *in_dev_branch_airs
  stage: test-infra

airs_infra_production_apply:
  <<: *with_nix
  <<: *in_master_branch_airs
  stage: deploy-infra

airs_infra_secret_management_test:
  <<: *with_nix
  <<: *in_dev_branch_airs
  stage: test-infra

airs_infra_secret_management_apply:
  <<: *with_nix
  <<: *in_master_branch_airs
  stage: deploy-infra
