.with_nix: &with_nix
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/nix:${CI_JOB_NAME}"
  needs: []
  script:
    - ./build.sh "${CI_JOB_NAME% *}"
  interruptible: true
  variables:
    GIT_DEPTH: 5

.airs_commit_pattern: &airs_commit_pattern '$CI_COMMIT_TITLE =~ /^(all|airs)/'

.in_dev_branch_airs: &in_dev_branch_airs
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *airs_commit_pattern

.in_master_branch_airs: &in_master_branch_airs
  resource_group: "${CI_JOB_NAME}"
  rules:
    - if: '$CI_COMMIT_BRANCH != "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *airs_commit_pattern

.in_dev_and_master_branch_airs: &in_dev_and_master_branch_airs
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: *airs_commit_pattern

.makes: &makes
  tags: [autoscaling]
  image: "${CI_REGISTRY_IMAGE}/makes:ci2"
  needs: []
  interruptible: true
  script:
    - ./m "${CI_JOB_NAME% *}"
  variables:
    GIT_DEPTH: 5

airs.eph-stop:
  <<: *makes
  script:
    - ./m airs eph-stop
  stage: deploy-app
  environment:
    name: ephemeral/${CI_COMMIT_REF_NAME}
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "trigger"'
      when: never
    - if: *airs_commit_pattern
      when: manual

airs.infra.ephemeral.apply:
  <<: *makes
  <<: *in_master_branch_airs
  stage: deploy-infra

airs.infra.ephemeral.test:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: test-infra

airs.infra.production.apply:
  <<: *makes
  <<: *in_master_branch_airs
  stage: deploy-infra

airs.infra.production.test:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: test-infra

airs.infra.secrets.apply:
  <<: *makes
  <<: *in_master_branch_airs
  stage: deploy-infra

airs.infra.secrets.test:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: test-infra

airs.test.images.covers:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: test-code

airs.test.images.format:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: test-code

airs.test.images.size:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: test-code

makes.test.airs:
  <<: *makes
  <<: *in_master_branch_airs
  stage: test-code

airs.lint.code:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: lint-code
  allow_failure: true

airs.lint.content:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: lint-code

airs.lint.styles:
  <<: *makes
  <<: *in_dev_branch_airs
  stage: lint-code

# Migrated to makes, but pending to finish gatsby migration

airs_deploy_ephemeral:
  <<: *with_nix
  <<: *in_dev_branch_airs
  stage: deploy-app
  environment:
    name: ephemeral/${CI_COMMIT_REF_NAME}
    url: https://web.eph.fluidattacks.com/${CI_COMMIT_REF_NAME}/
    on_stop: airs.eph-stop
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
    - airs/cache/

airs_deploy_production:
  <<: *with_nix
  <<: *in_master_branch_airs
  stage: deploy-app

airs_test_lint_code:
  <<: *with_nix
  <<: *in_dev_branch_airs
  stage: test-code

airs_test_lint_styles:
  <<: *with_nix
  <<: *in_dev_branch_airs
  stage: test-code
