---
- name: Installs docker host file for fluid-serves
  hosts: container
  become: "yes"

  vars:
    destdir: /tmp/fluid-serves
    vault_pass: "{{ lookup('env','VAULT') }}"
  gather_facts: "False"
  tasks:
    - name: Wait for SSH become available on instance
      local_action: wait_for port=22 host={{inventory_hostname}} delay=10

    - name: Add vault password
      lineinfile:
        dest: /root/.vault.txt
        line: "{{ vault_pass }}"
        create: "yes"

    - name: Incluir variables de configuracion
      include_vars: vars/vars.yml

    - name: Agregar netrc
      template:
        src: "vars/netrc.j2"
        dest: "/root/.netrc"
        mode: "0600"
      register: confvars

    - name: Copy vault
      command: cp /home/core/.vault.txt /root/
      when: confvars

    - name: View if exist .vault.txt
      local_action: stat path="/root/.vault.txt"
      register: result

    - name: Clonar repositorio serves
      git:
        repo: "https://jrestrepoatfluid@bitbucket.org/fluidsignal/fluid-serves.git"
        dest: "/root/fluid-serves"
        version: "master"
      register: repo

    - name: Retirar git conf
      file:
        path: "/root/.netrc"
        state: absent

    - name: Execute start.sh
      command: "/root/fluid-serves/start.sh"
      args:
        chdir: "/root/fluid-serves"
      when: repo
