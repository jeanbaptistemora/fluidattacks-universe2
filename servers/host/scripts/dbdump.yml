---
- hosts: localhost
  tasks:
   - name: Inlcuir variables (Vault)
     include_vars: vars/vars0.yml
   - name: Inlcuir ruta
     include_vars: vars/vars1.yml

   - name: Instalar paquetes necesarios
     apt:
      pkg: "{{ item }}"
      state: installed
     register: dependencias
     with_items:
      - curl
      - git
      - mysql-server
      - python-mysqldb
      - unzip
      - cron
      - python-boto

   - name: Obtener BD de S3
     s3:
      aws_access_key: "{{aws_access_key}}"
      aws_secret_key: "{{aws_secret_key}}"
      bucket: "{{ s3bucket }}"
      object: "exams/{{ db_name }}.sql"
      dest: "/tmp/{{ db_name }}.sql"
      mode: get

   - name: Crear DB para moodle
     mysql_db:
      login_user: "root"
      login_password: "{{ db_pwd_root }}"
      login_host: "{{ db_host }}"
      host: "{{ db_host }}"
      name: "{{ db_name }}"
      state: import
      target: "/tmp/{{ db_name }}.sql"

   - name: Crear usuario moodle y asignar permisos
     mysql_user:
      login_user: root
      login_password: "{{ db_pwd_root }}"
      login_host: "{{ db_host }}"
      host: "{{ db_host }}"
      name: "{{ db_username }}"
      password: "{{ db_password }}"
      priv: "{{ db_name }}.*:ALL"

   - name: Remover base de datos de prueba
     mysql_db:
      login_user: root
      login_password: "{{ db_pwd_root }}"
      login_host: "{{ db_host }}"
      host: "{{ db_host }}"
      name: "test"
      state: absent

   - name: Remover conexiones anonimas MySQL
     mysql_user:
      login_user: root
      login_password: "{{ db_pwd_root }}"
      login_host: "{{ db_host }}"
      host: "{{ db_host }}"
      name: ''
      state: absent
